
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tomodrgn.commands.train_vae &#8212; tomoDRGN 0.2.3.dev328 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../../_static/documentation_options.js?v=d6c7774d"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/tomodrgn/commands/train_vae';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">tomoDRGN v0.2.3.dev328</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../overview/index.html">
    Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../command_usage/index.html">
    Command Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../overview/index.html">
    Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../command_usage/index.html">
    Command Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">tomodrgn.commands.train_vae</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for tomodrgn.commands.train_vae</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Train a VAE for heterogeneous reconstruction with known pose for tomography data</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">get_args</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span>
<span class="kn">import</span> <span class="nn">torch.amp</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span>

<span class="kn">from</span> <span class="nn">tomodrgn</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">ctf</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">convergence</span>
<span class="kn">from</span> <span class="nn">tomodrgn.beta_schedule</span> <span class="kn">import</span> <span class="n">get_beta_schedule</span>
<span class="kn">from</span> <span class="nn">tomodrgn.dataset</span> <span class="kn">import</span> <span class="n">load_sta_dataset</span><span class="p">,</span> <span class="n">TiltSeriesMRCData</span><span class="p">,</span> <span class="n">TomoParticlesMRCData</span>
<span class="kn">from</span> <span class="nn">tomodrgn.lattice</span> <span class="kn">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">tomodrgn.models</span> <span class="kn">import</span> <span class="n">TiltSeriesHetOnlyVAE</span><span class="p">,</span> <span class="n">DataParallelPassthrough</span><span class="p">,</span> <span class="n">print_tiltserieshetonlyvae_ascii</span>
<span class="kn">from</span> <span class="nn">tomodrgn.starfile</span> <span class="kn">import</span> <span class="n">load_sta_starfile</span><span class="p">,</span> <span class="n">KNOWN_STAR_SOURCES</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">log</span>
<span class="n">vlog</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">vlog</span>


<div class="viewcode-block" id="add_args">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.add_args.html#tomodrgn.commands.train_vae.add_args">[docs]</a>
<span class="k">def</span> <span class="nf">add_args</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># this script is called directly; need to create a parser</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this script is called from tomodrgn.__main__ entry point, in which case a parser is already created</span>
        <span class="k">pass</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input particles_imageseries.star (if using Warp/M or NextPYP), or optimisation set star file (if using WarpTools or RELION v5)&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Core arguments&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--outdir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output directory to save model&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--zdim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Dimension of latent variable&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--load&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;WEIGHTS.PKL&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Initialize training from a checkpoint&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--checkpoint&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Checkpointing interval in N_EPOCHS (default: </span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--log-interval&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Logging interval in N_PTCLS (default: </span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Increases verbosity&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--seed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Random seed&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot-format&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;svgz&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;File format with which to save plots&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Particle starfile loading and filtering&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--source-software&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">get_args</span><span class="p">(</span><span class="n">KNOWN_STAR_SOURCES</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Manually set the software used to extract particles. Default is to auto-detect.&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ind-ptcls&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;PKL&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filter starfile by particles (unique rlnGroupName values) using np array pkl as indices&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ind-imgs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filter starfile by particle images (star file rows) using np array pkl as indices&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sort-ptcl-imgs&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;unsorted&#39;</span><span class="p">,</span> <span class="s1">&#39;dose_ascending&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;unsorted&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Sort the star file images on a per-particle basis by the specified criteria&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--use-first-ntilts&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Keep the first `use_first_ntilts` images of each particle in the sorted star file.&#39;</span>
                                                                        <span class="s1">&#39;Default -1 means to use all. Will drop particles with fewer than this many tilt images.&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--use-first-nptcls&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Keep the first `use_first_nptcls` particles in the sorted star file. Default -1 means to use all.&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Particle starfile train/test split&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--fraction-train&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Derive new train/test split with this fraction of each particles images assigned to train&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--show-summary-stats&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Log distribution statistics of particle sampling for test/train splits&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Dataset loading and preprocessing&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--uninvert-data&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;invert_data&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not invert data sign&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-window&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Turn off real space windowing of dataset&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--window-r&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Real space inner windowing radius to begin cosine falloff&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--window-r-outer&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Real space outer windowing radius to end cosine falloff&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--datadir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path prefix to particle stack if loading relative paths from a .star file&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lazy&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Lazy loading if full dataset is too large to fit in memory (Should copy dataset to SSD)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sequential-tilt-sampling&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Supply particle images of one particle to encoder in filtered starfile order&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Weighting and masking&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--recon-tilt-weight&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Weight reconstruction loss by cosine(tilt_angle)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--recon-dose-weight&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Weight reconstruction loss per tilt per pixel by dose dependent amplitude attenuation&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--l-dose-mask&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not train on frequencies exposed to &gt; 2.5x critical dose. Training lattice is intersection of this with --l-extent&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Training parameters&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--num-epochs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of training epochs&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--batch-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minibatch size&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--wd&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Weight decay in Adam optimizer&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Learning rate in Adam optimizer for batch size 1. Is automatically further scaled as square-root of batch size.&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--beta&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Choice of beta schedule or a constant for KLD weight&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--beta-control&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;KL-Controlled VAE gamma. Beta is KL target&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--norm&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data normalization as shift, 1/scale (default: 0, std of dataset)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-amp&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Disable use of mixed-precision training&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--multigpu&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Parallelize training across all detected GPUs&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Encoder Network&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--enc-layers-A&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;qlayersA&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of hidden layers for each tilt&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--enc-dim-A&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;qdimA&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of nodes in hidden layers for each tilt&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--out-dim-A&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of nodes in output layer of encA == ntilts * number of nodes input to encB&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--enc-layers-B&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;qlayersB&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of hidden layers encoding merged tilts&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--enc-dim-B&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;qdimB&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of nodes in hidden layers encoding merged tilts&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--enc-mask&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Diameter of circular mask of image for encoder in pixels (default: boxsize+1 to use up to Nyquist; -1 for no mask)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pooling-function&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;concatenate&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;set_encoder&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;concatenate&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Function used to pool features along ntilts dimension after encA&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num-seeds&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of seeds for PMA&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num-heads&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of heads for multi head attention blocks&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--layer-norm&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;whether to apply layer normalization in the set transformer block&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Decoder Network&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dec-layers&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;players&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of hidden layers&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dec-dim&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;pdim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of nodes in hidden layers&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--l-extent&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Coordinate lattice size (if not using positional encoding) (default: </span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pe-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;geom_ft&#39;</span><span class="p">,</span> <span class="s1">&#39;geom_full&#39;</span><span class="p">,</span> <span class="s1">&#39;geom_lowf&#39;</span><span class="p">,</span> <span class="s1">&#39;geom_nohighf&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_lowf&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of positional encoding&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--feat-sigma&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Scale for random Gaussian features&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pe-dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Num features in positional encoding&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--activation&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="s1">&#39;leaky_relu&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Activation&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Dataloader arguments&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num-workers&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of workers to use when batching particles for training. Has moderate impact on epoch time&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--prefetch-factor&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of particles to prefetch per worker for training. Has moderate impact on epoch time&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--persistent-workers&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to persist workers after dataset has been fully consumed. Has minimal impact on run time&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pin-memory&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to use pinned memory for dataloader. Has large impact on epoch time. Recommended.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span></div>



<div class="viewcode-block" id="train_batch">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.train_batch.html#tomodrgn.commands.train_vae.train_batch">[docs]</a>
<span class="k">def</span> <span class="nf">train_batch</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                <span class="n">model</span><span class="p">:</span> <span class="n">TiltSeriesHetOnlyVAE</span> <span class="o">|</span> <span class="n">DataParallelPassthrough</span><span class="p">,</span>
                <span class="n">scaler</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">,</span>
                <span class="n">optim</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span>
                <span class="n">lat</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span>
                <span class="n">batch_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">batch_rots</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">batch_trans</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">batch_ctf_params</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">batch_recon_error_weights</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">batch_hartley_2d_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">image_ctf_premultiplied</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="n">image_dose_weighted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">beta_control</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">use_amp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a TiltSeriesHetOnlyVAE model on a batch of tilt series particle images.</span>

<span class="sd">    :param model: TiltSeriesHetOnlyVAE object to be trained</span>
<span class="sd">    :param scaler: GradScaler object to be used for scaling loss involving fp16 tensors to avoid over/underflow</span>
<span class="sd">    :param optim: torch.optim.Optimizer object to be used for optimizing the model</span>
<span class="sd">    :param lat: Hartley-transform lattice of points for voxel grid operations</span>
<span class="sd">    :param batch_images: Batch of images to be used for training, shape (batchsize, ntilts, boxsize_ht, boxsize_ht)</span>
<span class="sd">    :param batch_rots: Batch of 3-D rotation matrices corresponding to `batch_images` known poses, shape (batchsize, ntilts, 3, 3)</span>
<span class="sd">    :param batch_trans: Batch of 2-D translation matrices corresponding to `batch_images` known poses, shape (batchsize, ntilts, 2).</span>
<span class="sd">            May be `torch.zeros((batchsize))` instead to indicate no translations should be applied to the input images.</span>
<span class="sd">    :param batch_ctf_params: Batch of CTF parameters corresponding to `batch_images` known CTF parameters, shape (batchsize, ntilts, 9).</span>
<span class="sd">            May be `torch.zeros((batchsize))` instead to indicate no CTF corruption should be applied to the reconstructed slice.</span>
<span class="sd">    :param batch_recon_error_weights: Batch of 2-D weights to be applied to the per-spatial-frequency error between the reconstructed slice and the input image.</span>
<span class="sd">            Calculated from critical dose exposure curves and electron beam vs sample tilt geometry.</span>
<span class="sd">            May be `torch.zeros((batchsize))` instead to indicate no weighting should be applied to the reconstructed slice error.</span>
<span class="sd">    :param batch_hartley_2d_mask: Batch of 2-D masks to be applied per-spatial-frequency.</span>
<span class="sd">            Calculated as the intersection of critical dose exposure curves and a Nyquist-limited circular mask in reciprocal space, including masking the DC component.</span>
<span class="sd">    :param image_ctf_premultiplied: Whether images were multiplied by their CTF during particle extraction.</span>
<span class="sd">    :param image_dose_weighted: Whether images were multiplied by their exposure-dependent frequency weighting during particle extraction.</span>
<span class="sd">    :param beta: scaling factor to apply to KLD during loss calculation.</span>
<span class="sd">    :param beta_control: KL-Controlled VAE gamma. Beta is KL target.</span>
<span class="sd">    :param use_amp: If true, use Automatic Mixed Precision to reduce memory consumption and accelerate code execution via `autocast` and `GradScaler`</span>
<span class="sd">    :return: numpy array of losses: total loss, generative loss between reconstructed slices and input images, and kld loss between latent embeddings and standard normal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># prepare to train a new batch</span>
    <span class="n">optim</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="c1"># autocast auto-enabled and set to correct device</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">lat</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">use_amp</span><span class="p">):</span>
        <span class="c1"># center images via translation and phase flip for partial CTF correction</span>
        <span class="n">batch_images_preprocessed</span><span class="p">,</span> <span class="n">batch_ctf_weights</span> <span class="o">=</span> <span class="n">preprocess_batch</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                                                        <span class="n">batch_images</span><span class="o">=</span><span class="n">batch_images</span><span class="p">,</span>
                                                                        <span class="n">batch_trans</span><span class="o">=</span><span class="n">batch_trans</span><span class="p">,</span>
                                                                        <span class="n">batch_ctf_params</span><span class="o">=</span><span class="n">batch_ctf_params</span><span class="p">,</span>
                                                                        <span class="n">image_ctf_premultiplied</span><span class="o">=</span><span class="n">image_ctf_premultiplied</span><span class="p">)</span>
        <span class="c1"># encode the translated and CTF-phase-flipped images</span>
        <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_logvar</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">encode_batch</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                         <span class="n">batch_images</span><span class="o">=</span><span class="n">batch_images_preprocessed</span><span class="p">)</span>
        <span class="c1"># decode the lattice coordinate positions given the encoder-generated embeddings</span>
        <span class="n">batch_images_recon</span> <span class="o">=</span> <span class="n">decode_batch</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                          <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                          <span class="n">batch_rots</span><span class="o">=</span><span class="n">batch_rots</span><span class="p">,</span>
                                          <span class="n">batch_hartley_2d_mask</span><span class="o">=</span><span class="n">batch_hartley_2d_mask</span><span class="p">,</span>
                                          <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># calculate the model loss</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">gen_loss</span><span class="p">,</span> <span class="n">kld_loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">z_mu</span><span class="o">=</span><span class="n">z_mu</span><span class="p">,</span>
                                                 <span class="n">z_logvar</span><span class="o">=</span><span class="n">z_logvar</span><span class="p">,</span>
                                                 <span class="n">batch_images</span><span class="o">=</span><span class="n">batch_images_preprocessed</span><span class="p">,</span>
                                                 <span class="n">batch_images_recon</span><span class="o">=</span><span class="n">batch_images_recon</span><span class="p">,</span>
                                                 <span class="n">batch_ctf_weights</span><span class="o">=</span><span class="n">batch_ctf_weights</span><span class="p">,</span>
                                                 <span class="n">batch_recon_error_weights</span><span class="o">=</span><span class="n">batch_recon_error_weights</span><span class="p">,</span>
                                                 <span class="n">batch_hartley_2d_mask</span><span class="o">=</span><span class="n">batch_hartley_2d_mask</span><span class="p">,</span>
                                                 <span class="n">image_ctf_premultiplied</span><span class="o">=</span><span class="n">image_ctf_premultiplied</span><span class="p">,</span>
                                                 <span class="n">image_dose_weighted</span><span class="o">=</span><span class="n">image_dose_weighted</span><span class="p">,</span>
                                                 <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
                                                 <span class="n">beta_control</span><span class="o">=</span><span class="n">beta_control</span><span class="p">)</span>

    <span class="c1"># backpropogate the scaled loss and optimize model weights</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">gen_loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">kld_loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optim</span><span class="p">)</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">((</span><span class="n">loss</span><span class="p">,</span> <span class="n">gen_loss</span><span class="p">,</span> <span class="n">kld_loss</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span></div>



<div class="viewcode-block" id="preprocess_batch">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.preprocess_batch.html#tomodrgn.commands.train_vae.preprocess_batch">[docs]</a>
<span class="k">def</span> <span class="nf">preprocess_batch</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                     <span class="n">lat</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span>
                     <span class="n">batch_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                     <span class="n">batch_trans</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                     <span class="n">batch_ctf_params</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                     <span class="n">image_ctf_premultiplied</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Center images via translation and phase flip for partial CTF correction, as needed</span>

<span class="sd">    :param lat: Hartley-transform lattice of points for voxel grid operations</span>
<span class="sd">    :param batch_images: Batch of images to be used for training, shape (batchsize, ntilts, boxsize_ht, boxsize_ht)</span>
<span class="sd">    :param batch_trans: Batch of 2-D translation matrices corresponding to `batch_images` known poses, shape (batchsize, ntilts, 2).</span>
<span class="sd">            May be `torch.zeros((batchsize))` instead to indicate no translations should be applied to the input images.</span>
<span class="sd">    :param batch_ctf_params: Batch of CTF parameters corresponding to `batch_images` known CTF parameters, shape (batchsize, ntilts, 9).</span>
<span class="sd">            May be `torch.zeros((batchsize))` instead to indicate no CTF corruption should be applied to the reconstructed slice.</span>
<span class="sd">    :param image_ctf_premultiplied: Whether images were multiplied by their CTF during particle extraction.</span>
<span class="sd">    :return batch_images: translationally-centered and phase-flipped batch of images to be used for training, shape (batchsize, ntilts, boxsize_ht**2)</span>
<span class="sd">    :return batch_ctf_weights: CTF evaluated at each spatial frequency corresponding to input images, shape (batchsize, ntilts, boxsize_ht**2) or None if no CTF should be applied</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get key dimension sizes</span>
    <span class="n">batchsize</span><span class="p">,</span> <span class="n">ntilts</span><span class="p">,</span> <span class="n">boxsize_ht</span><span class="p">,</span> <span class="n">boxsize_ht</span> <span class="o">=</span> <span class="n">batch_images</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># translate the image</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">batch_trans</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">*</span><span class="n">batch_trans</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch_trans</span><span class="o">.</span><span class="n">device</span><span class="p">)):</span>
        <span class="n">batch_images</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">translate_ht</span><span class="p">(</span><span class="n">batch_images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batchsize</span> <span class="o">*</span> <span class="n">ntilts</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">batch_trans</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batchsize</span> <span class="o">*</span> <span class="n">ntilts</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># restore separation of batch dim and tilt dim (merged into batch dim during translation)</span>
    <span class="n">batch_images</span> <span class="o">=</span> <span class="n">batch_images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batchsize</span><span class="p">,</span> <span class="n">ntilts</span><span class="p">,</span> <span class="n">boxsize_ht</span> <span class="o">*</span> <span class="n">boxsize_ht</span><span class="p">)</span>

    <span class="c1"># phase flip the input CTF-corrupted image and calculate CTF weights to apply later</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">batch_ctf_params</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">*</span><span class="n">batch_ctf_params</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch_ctf_params</span><span class="o">.</span><span class="n">device</span><span class="p">)):</span>
        <span class="n">batch_ctf_weights</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">compute_ctf</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">batch_ctf_params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image_ctf_premultiplied</span><span class="p">:</span>
            <span class="n">batch_images</span> <span class="o">=</span> <span class="n">batch_images</span> <span class="o">*</span> <span class="n">batch_ctf_weights</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span>  <span class="c1"># phase flip by CTF to be all positive amplitudes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batch_ctf_weights</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">batch_images</span><span class="p">,</span> <span class="n">batch_ctf_weights</span></div>



<div class="viewcode-block" id="encode_batch">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.encode_batch.html#tomodrgn.commands.train_vae.encode_batch">[docs]</a>
<span class="k">def</span> <span class="nf">encode_batch</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                 <span class="n">model</span><span class="p">:</span> <span class="n">TiltSeriesHetOnlyVAE</span> <span class="o">|</span> <span class="n">DataParallelPassthrough</span><span class="p">,</span>
                 <span class="n">batch_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode a batch of particles represented by multiple images to per-particle latent embeddings</span>

<span class="sd">    :param model: TiltSeriesHetOnlyVAE object to be trained</span>
<span class="sd">    :param batch_images: Batch of images to be used for training, shape (batchsize, ntilts, boxsize_ht*2)</span>
<span class="sd">    :return: z_mu: Direct output of encoder module parameterizing the mean of the latent embedding for each particle, shape (batchsize, zdim)</span>
<span class="sd">    :return: z_logvar: Direct output of encoder module parameterizing the log variance of the latent embedding for each particle, shape (batchsize, zdim)</span>
<span class="sd">    :return: z: Resampling of the latent embedding for each particle parameterized as a gaussian with mean `z_mu` and variance `z_logvar`, shape (batchsize, zdim)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_logvar</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch_images</span><span class="p">)</span>  <span class="c1"># ouput is B x zdim, i.e. one value per ptcl (not per img)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">reparameterize</span><span class="p">(</span><span class="n">z_mu</span><span class="p">,</span> <span class="n">z_logvar</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_logvar</span><span class="p">,</span> <span class="n">z</span></div>



<div class="viewcode-block" id="decode_batch">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.decode_batch.html#tomodrgn.commands.train_vae.decode_batch">[docs]</a>
<span class="k">def</span> <span class="nf">decode_batch</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                 <span class="n">model</span><span class="p">:</span> <span class="n">TiltSeriesHetOnlyVAE</span> <span class="o">|</span> <span class="n">DataParallelPassthrough</span><span class="p">,</span>
                 <span class="n">lat</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span>
                 <span class="n">batch_rots</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                 <span class="n">batch_hartley_2d_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                 <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode a batch of particles represented by multiple images from per-particle latent embeddings and corresponding lattice positions to evaluate</span>

<span class="sd">    :param model: TiltSeriesHetOnlyVAE object to be trained</span>
<span class="sd">    :param lat: Hartley-transform lattice of points for voxel grid operations</span>
<span class="sd">    :param batch_rots: Batch of 3-D rotation matrices corresponding to `batch_images` known poses, shape (batchsize, ntilts, 3, 3)</span>
<span class="sd">    :param batch_hartley_2d_mask: Batch of 2-D masks to be applied per-spatial-frequency, shape (batchsize, ntilts, boxsize_ht**2)</span>
<span class="sd">            Calculated as the intersection of critical dose exposure curves and a Nyquist-limited circular mask in reciprocal space, including masking the DC component.</span>
<span class="sd">    :param z: Resampled latent embedding for each particle, shape (batchsize, zdim)</span>
<span class="sd">    :return: Reconstructed central slices of Fourier space volumes corresponding to each particle in the batch, shape (batchsize * ntilts * boxsize_ht**2 [`batch_hartley_2d_mask`]).</span>
<span class="sd">            Note that the returned array is completely flattened (including along batch dimension) due to potential for uneven/ragged reconstructed image tensors per-particle after masking</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># prepare lattice at rotated fourier components</span>
    <span class="n">input_coords</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">coords</span> <span class="o">@</span> <span class="n">batch_rots</span>  <span class="c1"># shape batchsize x ntilts x boxsize_ht**2 x 3 from [boxsize_ht**2 x 3] @ [batchsize x ntilts x 3 x 3]</span>

    <span class="c1"># filter by dec_mask to skip decoding coordinates that have low contribution to SNR</span>
    <span class="c1"># decode each particle one at a time due to variable # pixels in batch_hartley_2d_mask per particle producing ragged tensor</span>
    <span class="c1"># this will eventually be replaceable with pytorch NestedTensor, but as of torch v2.4 this still does not work at backprop (and does not support many common operations we need prior to that)</span>
    <span class="n">batch_images_recon</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords_ptcl</span><span class="p">[</span><span class="n">mask_ptcl</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">z</span><span class="o">=</span><span class="n">z_ptcl</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">coords_ptcl</span><span class="p">,</span> <span class="n">mask_ptcl</span><span class="p">,</span> <span class="n">z_ptcl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_coords</span><span class="p">,</span> <span class="n">batch_hartley_2d_mask</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch_images_recon</span></div>



<div class="viewcode-block" id="loss_function">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.loss_function.html#tomodrgn.commands.train_vae.loss_function">[docs]</a>
<span class="k">def</span> <span class="nf">loss_function</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                  <span class="n">z_mu</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                  <span class="n">z_logvar</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                  <span class="n">batch_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                  <span class="n">batch_images_recon</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                  <span class="n">batch_ctf_weights</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                  <span class="n">batch_recon_error_weights</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                  <span class="n">batch_hartley_2d_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                  <span class="n">image_ctf_premultiplied</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">image_dose_weighted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">beta_control</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate generative loss between reconstructed and input images, and beta-weighted KLD between latent embeddings and standard normal</span>

<span class="sd">    :param z_mu: Direct output of encoder module parameterizing the mean of the latent embedding for each particle, shape (batchsize, zdim)</span>
<span class="sd">    :param z_logvar: Direct output of encoder module parameterizing the log variance of the latent embedding for each particle, shape (batchsize, zdim)</span>
<span class="sd">    :param batch_images: Batch of images to be used for training, shape (batchsize, ntilts, boxsize_ht**2)</span>
<span class="sd">    :param batch_images_recon: Reconstructed central slices of Fourier space volumes corresponding to each particle in the batch, shape (batchsize * ntilts * boxsize_ht**2 [`batch_hartley_2d_mask`])</span>
<span class="sd">    :param batch_ctf_weights: CTF evaluated at each spatial frequency corresponding to input images, shape (batchsize, ntilts, boxsize_ht**2) or None if no CTF should be applied</span>
<span class="sd">    :param batch_recon_error_weights: Batch of 2-D weights to be applied to the per-spatial-frequency error between each reconstructed slice and input image, shape (batchsize, ntilts, boxsize_ht**2).</span>
<span class="sd">            Calculated from critical dose exposure curves and electron beam vs sample tilt geometry.</span>
<span class="sd">    :param batch_hartley_2d_mask: Batch of 2-D masks to be applied per-spatial-frequency.</span>
<span class="sd">            Calculated as the intersection of critical dose exposure curves and a Nyquist-limited circular mask in reciprocal space, including masking the DC component.</span>
<span class="sd">    :param image_ctf_premultiplied: Whether images were multiplied by their CTF during particle extraction.</span>
<span class="sd">    :param image_dose_weighted: Whether images were multiplied by their exposure-dependent frequency weighting during particle extraction.    :param beta: scaling factor to apply to KLD during loss calculation.</span>
<span class="sd">    :param beta: scaling factor to apply to KLD during loss calculation.</span>
<span class="sd">    :param beta_control: KL-Controlled VAE gamma. Beta is KL target.</span>
<span class="sd">    :return: total summed loss, generative loss between reconstructed slices and input images, and beta-weighted kld loss between latent embeddings and standard normal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># locally disable autocast for numerical stability in calculating losses, particularly with batch size &gt; 1 or equivalent large denominator for kld or large num pixels for mse</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">batch_images</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># upcast tensors for numerical stability in loss if amp was enabled upstream</span>
        <span class="n">batch_images</span> <span class="o">=</span> <span class="n">batch_images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">batch_images_recon</span> <span class="o">=</span> <span class="n">batch_images_recon</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">batch_ctf_weights</span> <span class="o">=</span> <span class="n">batch_ctf_weights</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">if</span> <span class="n">batch_ctf_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">batch_recon_error_weights</span> <span class="o">=</span> <span class="n">batch_recon_error_weights</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># reconstruction error</span>
        <span class="n">batch_images</span> <span class="o">=</span> <span class="n">batch_images</span><span class="p">[</span><span class="n">batch_hartley_2d_mask</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">batch_recon_error_weights</span> <span class="o">=</span> <span class="n">batch_recon_error_weights</span><span class="p">[</span><span class="n">batch_hartley_2d_mask</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_ctf_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batch_ctf_weights</span> <span class="o">=</span> <span class="n">batch_ctf_weights</span><span class="p">[</span><span class="n">batch_hartley_2d_mask</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">batch_images_recon</span> <span class="o">=</span> <span class="n">batch_images_recon</span> <span class="o">*</span> <span class="n">batch_ctf_weights</span>  <span class="c1"># apply CTF to reconstructed image</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">image_ctf_premultiplied</span><span class="p">:</span>
                <span class="c1"># undo phase flipping in place from preprocess_batch, this was only applied if images are not ctf premultiplied</span>
                <span class="n">batch_images</span> <span class="o">=</span> <span class="n">batch_images</span> <span class="o">*</span> <span class="n">batch_ctf_weights</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># reconstructed image needs to correspond to input ctf_premultiplied images, i.e. images that are doubly convolved with the CTF</span>
                <span class="n">batch_images_recon</span> <span class="o">=</span> <span class="n">batch_images_recon</span> <span class="o">*</span> <span class="n">batch_ctf_weights</span>  <span class="c1"># apply CTF to reconstructed image again</span>
        <span class="k">if</span> <span class="n">image_dose_weighted</span><span class="p">:</span>
            <span class="c1"># images may have been extracted with dose weights pre-applied</span>
            <span class="n">batch_images_recon</span> <span class="o">=</span> <span class="n">batch_images_recon</span> <span class="o">*</span> <span class="n">batch_recon_error_weights</span>
        <span class="n">gen_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">batch_recon_error_weights</span> <span class="o">*</span> <span class="p">((</span><span class="n">batch_images_recon</span> <span class="o">-</span> <span class="n">batch_images</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># latent loss</span>
        <span class="n">kld</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z_logvar</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">-</span> <span class="n">z_mu</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">z_logvar</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">exp</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">beta_control</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># denominator is the largest number of pixels included in single particle of any particle in batch</span>
            <span class="n">kld_loss</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">kld</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch_hartley_2d_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">z_mu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kld</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># denominator is the largest number of pixels included in single particle of any particle in batch</span>
            <span class="n">kld_loss</span> <span class="o">=</span> <span class="n">beta_control</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">kld</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch_hartley_2d_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">z_mu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kld</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># total loss</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">gen_loss</span> <span class="o">+</span> <span class="n">kld_loss</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">gen_loss</span><span class="p">,</span> <span class="n">kld_loss</span></div>



<div class="viewcode-block" id="encoder_inference">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.encoder_inference.html#tomodrgn.commands.train_vae.encoder_inference">[docs]</a>
<span class="k">def</span> <span class="nf">encoder_inference</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                      <span class="n">model</span><span class="p">:</span> <span class="n">TiltSeriesHetOnlyVAE</span> <span class="o">|</span> <span class="n">DataParallelPassthrough</span><span class="p">,</span>
                      <span class="n">lat</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span>
                      <span class="n">data</span><span class="p">:</span> <span class="n">TiltSeriesMRCData</span> <span class="o">|</span> <span class="n">TomoParticlesMRCData</span><span class="p">,</span>
                      <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">pin_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">use_amp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">batchsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run inference on the encoder module using the specified data as input to be embedded in latent space.</span>

<span class="sd">    :param model: TiltSeriesHetOnlyVAE object to be used for encoder module inference. Informs device on which to run inference.</span>
<span class="sd">    :param lat: Hartley-transform lattice of points for voxel grid operations</span>
<span class="sd">    :param data: TiltSeriesMRCData or TomoParticlesMRCData object for accessing tilt images with known CTF and pose parameters, to be embedded in latent space</span>
<span class="sd">    :param use_amp: If true, use Automatic Mixed Precision to reduce memory consumption and accelerate code execution via `torch.autocast`</span>
<span class="sd">    :param batchsize: batch size used in dataloader for model inference</span>
<span class="sd">    :param num_workers: Number of workers to use with dataloader when batching particles for inference.</span>
<span class="sd">    :param prefetch_factor: Number of particles to prefetch per worker with dataloader for inference.</span>
<span class="sd">    :param pin_memory: Whether to use pinned memory for dataloader.</span>
<span class="sd">    :return: Direct output of encoder module parameterizing the mean of the latent embedding for each particle, shape (batchsize, zdim).</span>
<span class="sd">            Direct output of encoder module parameterizing the log variance of the latent embedding for each particle, shape (batchsize, zdim)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># prepare to run model inference</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">training</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>

        <span class="c1"># autocast auto-enabled and set to correct device</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">lat</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">use_amp</span><span class="p">):</span>

            <span class="c1"># pre-allocate tensors to store outputs</span>
            <span class="n">z_mu_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">nptcls</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">zdim</span><span class="p">),</span>
                                   <span class="n">device</span><span class="o">=</span><span class="n">lat</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">half</span> <span class="k">if</span> <span class="n">use_amp</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">z_logvar_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z_mu_all</span><span class="p">)</span>

            <span class="c1"># create the dataloader iterator with shuffle False to preserve index alignment between input dataset and output latent</span>
            <span class="n">data_generator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                                         <span class="n">batch_size</span><span class="o">=</span><span class="n">batchsize</span><span class="p">,</span>
                                                         <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                         <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
                                                         <span class="n">prefetch_factor</span><span class="o">=</span><span class="n">prefetch_factor</span><span class="p">,</span>
                                                         <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># creating this dataloading for a single pass, no need for peristent workers</span>
                                                         <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">batch_images</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">batch_trans</span><span class="p">,</span> <span class="n">batch_ctf_params</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">batch_indices</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">:</span>
                <span class="c1"># transfer to GPU</span>
                <span class="n">batch_images</span> <span class="o">=</span> <span class="n">batch_images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">batch_ctf_params</span> <span class="o">=</span> <span class="n">batch_ctf_params</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">batch_trans</span> <span class="o">=</span> <span class="n">batch_trans</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                <span class="c1"># encode the translated and CTF-phase-flipped images</span>
                <span class="n">batch_images</span><span class="p">,</span> <span class="n">ctf_weights</span> <span class="o">=</span> <span class="n">preprocess_batch</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                                             <span class="n">batch_images</span><span class="o">=</span><span class="n">batch_images</span><span class="p">,</span>
                                                             <span class="n">batch_trans</span><span class="o">=</span><span class="n">batch_trans</span><span class="p">,</span>
                                                             <span class="n">batch_ctf_params</span><span class="o">=</span><span class="n">batch_ctf_params</span><span class="p">,</span>
                                                             <span class="n">image_ctf_premultiplied</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">image_ctf_premultiplied</span><span class="p">)</span>

                <span class="c1"># decode the lattice coordinate positions given the encoder-generated embeddings</span>
                <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_logvar</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">encode_batch</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                                 <span class="n">batch_images</span><span class="o">=</span><span class="n">batch_images</span><span class="p">)</span>

                <span class="c1"># store latent embeddings in master array</span>
                <span class="n">z_mu_all</span><span class="p">[</span><span class="n">batch_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_mu</span>
                <span class="n">z_logvar_all</span><span class="p">[</span><span class="n">batch_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_logvar</span>

            <span class="c1"># when dataset is fully exhausted, move latent embeddings to cpu-based numpy arrays</span>
            <span class="n">z_mu_all</span> <span class="o">=</span> <span class="n">z_mu_all</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">z_logvar_all</span> <span class="o">=</span> <span class="n">z_logvar_all</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="c1"># sanity check that no latent embeddings are NaN or inf, which could happen with AMP enabled</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">z_mu_all</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">z_mu_all</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
                <span class="n">nan_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z_mu_all</span><span class="p">))</span>
                <span class="n">inf_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">z_mu_all</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Latent evaluation at end of epoch failed: z.pkl would contain </span><span class="si">{</span><span class="n">nan_count</span><span class="si">}</span><span class="s1"> NaN and </span><span class="si">{</span><span class="n">inf_count</span><span class="si">}</span><span class="s1"> Inf&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">z_mu_all</span><span class="p">,</span> <span class="n">z_logvar_all</span></div>



<div class="viewcode-block" id="save_checkpoint">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.save_checkpoint.html#tomodrgn.commands.train_vae.save_checkpoint">[docs]</a>
<span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                    <span class="n">model</span><span class="p">:</span> <span class="n">TiltSeriesHetOnlyVAE</span> <span class="o">|</span> <span class="n">DataParallelPassthrough</span><span class="p">,</span>
                    <span class="n">scaler</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">,</span>
                    <span class="n">optim</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span>
                    <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">z_mu_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">z_logvar_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">out_weights</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">out_z_train</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">z_mu_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">z_logvar_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">out_z_test</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save model weights and latent encoding z</span>

<span class="sd">    :param model: TiltSeriesHetOnlyVAE object used for model training and evaluation</span>
<span class="sd">    :param scaler: GradScaler object used for scaling loss involving fp16 tensors to avoid over/underflow</span>
<span class="sd">    :param optim: torch.optim.Optimizer object used for optimizing the model</span>
<span class="sd">    :param epoch: epoch count at which checkpoint is being saved</span>
<span class="sd">    :param z_mu_train: array of latent embedding means for the dataset train split</span>
<span class="sd">    :param z_logvar_train: array of latent embedding log variances for the dataset train split</span>
<span class="sd">    :param out_weights: name of output file to save model, optimizer, and scaler state dicts</span>
<span class="sd">    :param out_z_train: name of output file to save latent embeddings for dataset train split</span>
<span class="sd">    :param z_mu_test: array of latent embedding log variances for the dataset test split</span>
<span class="sd">    :param z_logvar_test: array of latent embedding log variances for the dataset test split</span>
<span class="sd">    :param out_z_test: name of output file to save latent embeddings for dataset test split</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># save model weights</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
        <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
        <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">:</span> <span class="n">optim</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="s1">&#39;scaler&#39;</span><span class="p">:</span> <span class="n">scaler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">},</span> <span class="n">out_weights</span><span class="p">)</span>

    <span class="c1"># save latent embeddings from dataset train split</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_z_train</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">z_mu_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">z_logvar_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># save latent embeddings from dataset test split</span>
    <span class="k">if</span> <span class="n">z_mu_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_z_test</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">z_mu_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">z_logvar_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../api/_autosummary/tomodrgn.commands.train_vae.main.html#tomodrgn.commands.train_vae.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/run.log&#39;</span>

    <span class="k">def</span> <span class="nf">flog</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>  <span class="c1"># HACK: switch to logging module</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">flog</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
        <span class="n">latest_epoch</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_latest_epoch</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">load</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/weights.</span><span class="si">{</span><span class="n">latest_epoch</span><span class="si">}</span><span class="s1">.pkl&#39;</span>
    <span class="n">flog</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>
    <span class="n">flog</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># set the random seed</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># set the device</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_default_device</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_amp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;Warning: pytorch AMP does not support non-CUDA (e.g. cpu) devices. Automatically disabling AMP and continuing&#39;</span><span class="p">)</span>
        <span class="c1"># https://github.com/pytorch/pytorch/issues/55374</span>

    <span class="c1"># load star file</span>
    <span class="n">ptcls_star</span> <span class="o">=</span> <span class="n">load_sta_starfile</span><span class="p">(</span><span class="n">star_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span>
                                   <span class="n">source_software</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">source_software</span><span class="p">)</span>
    <span class="n">ptcls_star</span><span class="o">.</span><span class="n">plot_particle_uid_ntilt_distribution</span><span class="p">(</span><span class="n">outpath</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ptcls_star</span><span class="o">.</span><span class="n">sourcefile</span><span class="p">)</span><span class="si">}</span><span class="s1">_particle_uid_ntilt_distribution.</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">plot_format</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># filter star file</span>
    <span class="n">ptcls_star</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ind_imgs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ind_imgs</span><span class="p">,</span>
                      <span class="n">ind_ptcls</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ind_ptcls</span><span class="p">,</span>
                      <span class="n">sort_ptcl_imgs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sort_ptcl_imgs</span><span class="p">,</span>
                      <span class="n">use_first_ntilts</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_first_ntilts</span><span class="p">,</span>
                      <span class="n">use_first_nptcls</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_first_nptcls</span><span class="p">)</span>

    <span class="c1"># split ptcls_star by into half sets per-particle for independent backprojection</span>
    <span class="n">ptcls_star</span><span class="o">.</span><span class="n">make_test_train_split</span><span class="p">(</span><span class="n">fraction_split1</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fraction_train</span><span class="p">,</span>
                                     <span class="n">show_summary_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># save filtered star file for future convenience (aligning latent embeddings with particles, re-extracting particles, mapbacks, etc.)</span>
    <span class="n">outstar</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ptcls_star</span><span class="o">.</span><span class="n">sourcefile</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_tomodrgn_preprocessed.star&#39;</span>
    <span class="n">ptcls_star</span><span class="o">.</span><span class="n">sourcefile_filtered</span> <span class="o">=</span> <span class="n">outstar</span>
    <span class="n">ptcls_star</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outstar</span><span class="p">)</span>

    <span class="c1"># load the particles + poses + ctf from input starfile</span>
    <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading dataset from </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">particles</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">datadir</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">datadir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ptcls_star</span><span class="o">.</span><span class="n">sourcefile</span><span class="p">)</span>
    <span class="n">data_train</span> <span class="o">=</span> <span class="n">load_sta_dataset</span><span class="p">(</span><span class="n">ptcls_star</span><span class="o">=</span><span class="n">ptcls_star</span><span class="p">,</span>
                                  <span class="n">star_random_subset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span>
                                  <span class="n">lazy</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lazy</span><span class="p">,</span>
                                  <span class="n">norm</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span>
                                  <span class="n">invert_data</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">invert_data</span><span class="p">,</span>
                                  <span class="n">window</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
                                  <span class="n">window_r</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">window_r</span><span class="p">,</span>
                                  <span class="n">window_r_outer</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">window_r_outer</span><span class="p">,</span>
                                  <span class="n">recon_dose_weight</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">recon_dose_weight</span><span class="p">,</span>
                                  <span class="n">recon_tilt_weight</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">recon_tilt_weight</span><span class="p">,</span>
                                  <span class="n">l_dose_mask</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l_dose_mask</span><span class="p">,</span>
                                  <span class="n">constant_mintilt_sampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">sequential_tilt_sampling</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sequential_tilt_sampling</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fraction_train</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">data_test</span> <span class="o">=</span> <span class="n">load_sta_dataset</span><span class="p">(</span><span class="n">ptcls_star</span><span class="o">=</span><span class="n">ptcls_star</span><span class="p">,</span>
                                     <span class="n">star_random_subset</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                     <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span>
                                     <span class="n">lazy</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lazy</span><span class="p">,</span>
                                     <span class="n">norm</span><span class="o">=</span><span class="n">data_train</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span>
                                     <span class="n">invert_data</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">invert_data</span><span class="p">,</span>
                                     <span class="n">window</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
                                     <span class="n">window_r</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">window_r</span><span class="p">,</span>
                                     <span class="n">window_r_outer</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">window_r_outer</span><span class="p">,</span>
                                     <span class="n">recon_dose_weight</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">recon_dose_weight</span><span class="p">,</span>
                                     <span class="n">recon_tilt_weight</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">recon_tilt_weight</span><span class="p">,</span>
                                     <span class="n">l_dose_mask</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l_dose_mask</span><span class="p">,</span>
                                     <span class="n">constant_mintilt_sampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">sequential_tilt_sampling</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sequential_tilt_sampling</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_test</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">boxsize_ht</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">boxsize_ht</span>
    <span class="n">nptcls</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">nptcls</span>
    <span class="n">image_ctf_premultiplied</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">image_ctf_premultiplied</span>
    <span class="n">image_dose_weighted</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">image_dose_weighted</span>
    <span class="n">ctf</span><span class="o">.</span><span class="n">print_ctf_params</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">ctf_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># instantiate lattice</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">boxsize_ht</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l_extent</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># determine which pixels to encode (equivalently applicable to all particles)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">enc_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">enc_mask</span> <span class="o">=</span> <span class="n">boxsize_ht</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">enc_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># encode pixels within defined circular radius in fourier space</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">enc_mask</span> <span class="o">&lt;=</span> <span class="n">boxsize_ht</span>
        <span class="n">enc_mask</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">get_circular_mask</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">enc_mask</span><span class="p">)</span>
        <span class="n">in_dim</span> <span class="o">=</span> <span class="n">enc_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">enc_mask</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># encode all pixels in fourier space</span>
        <span class="n">enc_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">in_dim</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">boxsize</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid argument for encoder mask radius </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">enc_mask</span><span class="p">))</span>
    <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pixels encoded per tilt (+ enc-mask):  </span><span class="si">{</span><span class="n">in_dim</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># determine the number of tilts to randomly sample per particle during training and testing</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if batchsize == 1:</span>
<span class="sd">            can have any number of tilts per particle (recognize via ntilts_training==None?)</span>
<span class="sd">        if batchsize &gt; 1:</span>
<span class="sd">            if number of tilts differs between particles:</span>
<span class="sd">                may cause errors during batch collation before starting batch</span>
<span class="sd">                may be able to get by with nestedtensor or alternate clever dtype </span>
<span class="sd">                or zero padding &quot;fake&quot; images and subselecting on GPU as appropriate</span>
<span class="sd">                otherwise require use_first_ntilts to truncate?</span>
<span class="sd">            else:   </span>
<span class="sd">                can have any number of tilts per particle</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">multigpu</span><span class="p">:</span>
            <span class="c1"># can sample all images specified by inds_train and inds_test for each particle in each batch.</span>
            <span class="c1"># this works even if different particles have different numbers of tilts because we have batch size 1,</span>
            <span class="c1"># so we do not need to worry about dataloader collating ragged tensors in the ntilts dimension</span>
            <span class="n">data_train</span><span class="o">.</span><span class="n">constant_mintilt_sampling</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Will sample all train tilts of each particle for train split, to pass to encoder, due to model requirements of --pooling-function </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fraction_train</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data_test</span><span class="o">.</span><span class="n">constant_mintilt_sampling</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Will sample all test tilts of each particle for test split, to pass to encoder, due to model requirements of --pooling-function </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO implement ntilt_training calculation for set-style encoder with batchsize &gt; 1</span>
            <span class="k">if</span> <span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_training</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Will sample </span><span class="si">{</span><span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_training</span><span class="si">}</span><span class="s1"> tilts per particle for train split, to pass to encoder, due to model requirements of --pooling-function </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;concatenate&#39;</span><span class="p">,</span> <span class="s1">&#39;set_encoder&#39;</span><span class="p">]:</span>
        <span class="c1"># requires same number of tilts for both test and train for every particle</span>
        <span class="c1"># therefore add further subset train/test to sample same number of tilts from each for each particle</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fraction_train</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">n_tilts_for_model</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_test</span><span class="o">.</span><span class="n">ntilts_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_training</span> <span class="o">=</span> <span class="n">n_tilts_for_model</span>
            <span class="n">data_test</span><span class="o">.</span><span class="n">ntilts_training</span> <span class="o">=</span> <span class="n">n_tilts_for_model</span>
            <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Will sample </span><span class="si">{</span><span class="n">n_tilts_for_model</span><span class="si">}</span><span class="s1"> tilts per particle for model input, for each of test and train, due to model requirements of --pooling-function </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_tilts_for_model</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_training</span> <span class="o">=</span> <span class="n">n_tilts_for_model</span>
            <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Will sample </span><span class="si">{</span><span class="n">n_tilts_for_model</span><span class="si">}</span><span class="s1"> tilts per particle for model input, for train split, due to model requirements of --pooling-function </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># instantiate model</span>
    <span class="n">activation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;relu&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">,</span> <span class="s2">&quot;leaky_relu&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">}[</span><span class="n">args</span><span class="o">.</span><span class="n">activation</span><span class="p">]</span>
    <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pooling function prior to encoder B: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">TiltSeriesHetOnlyVAE</span><span class="p">(</span><span class="n">in_dim</span><span class="o">=</span><span class="n">in_dim</span><span class="p">,</span>
                                 <span class="n">hidden_layers_a</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">qlayersA</span><span class="p">,</span>
                                 <span class="n">hidden_dim_a</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">qdimA</span><span class="p">,</span>
                                 <span class="n">out_dim_a</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">out_dim_A</span><span class="p">,</span>
                                 <span class="n">ntilts</span><span class="o">=</span><span class="n">data_train</span><span class="o">.</span><span class="n">ntilts_training</span><span class="p">,</span>
                                 <span class="n">hidden_layers_b</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">qlayersB</span><span class="p">,</span>
                                 <span class="n">hidden_dim_b</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">qdimB</span><span class="p">,</span>
                                 <span class="n">zdim</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">zdim</span><span class="p">,</span>
                                 <span class="n">hidden_layers_decoder</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">players</span><span class="p">,</span>
                                 <span class="n">hidden_dim_decoder</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pdim</span><span class="p">,</span>
                                 <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                 <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                                 <span class="n">enc_mask</span><span class="o">=</span><span class="n">enc_mask</span><span class="p">,</span>
                                 <span class="n">pooling_function</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pooling_function</span><span class="p">,</span>
                                 <span class="n">feat_sigma</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">feat_sigma</span><span class="p">,</span>
                                 <span class="n">num_seeds</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_seeds</span><span class="p">,</span>
                                 <span class="n">num_heads</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_heads</span><span class="p">,</span>
                                 <span class="n">layer_norm</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">layer_norm</span><span class="p">,</span>
                                 <span class="n">pe_type</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pe_type</span><span class="p">,</span>
                                 <span class="n">pe_dim</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pe_dim</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">print_tiltserieshetonlyvae_ascii</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># model.print_model_info()</span>

    <span class="c1"># save configuration</span>
    <span class="n">out_config</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/config.pkl&#39;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                       <span class="n">star</span><span class="o">=</span><span class="n">ptcls_star</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
                       <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                       <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                       <span class="n">out_config</span><span class="o">=</span><span class="n">out_config</span><span class="p">)</span>

    <span class="c1"># set beta schedule</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">zdim</span>
    <span class="n">beta_schedule</span> <span class="o">=</span> <span class="n">get_beta_schedule</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">*</span> <span class="n">nptcls</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

    <span class="c1"># instantiate optimizer</span>
    <span class="n">args</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">sequential_tilt_sampling</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Scaling learning rate larger by 2 due to using random tilt sampling&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final learning rate after scaling by square root of batch size: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">optim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                              <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span>
                              <span class="n">weight_decay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span>
                              <span class="n">eps</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>  <span class="c1"># https://github.com/pytorch/pytorch/issues/40497#issuecomment-1084807134</span>

    <span class="c1"># Mixed precision training with AMP</span>
    <span class="n">use_amp</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_amp</span>
    <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;AMP acceleration enabled (autocast + gradscaler) : </span><span class="si">{</span><span class="n">use_amp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">use_amp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_amp</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;Warning: recommended to have batch size divisible by 8 for AMP training&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">boxsize_ht</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;Warning: recommended to have image size divisible by 8 for AMP training&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">in_dim</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;Warning: recommended to have masked image dimensions divisible by 8 for AMP training&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">qdimA</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Encoder hidden layer dimension must be divisible by 8 for AMP training&quot;</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">qdimB</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Encoder hidden layer dimension must be divisible by 8 for AMP training&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">zdim</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;Warning: recommended to have z dimension divisible by 8 for AMP training&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">pdim</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Decoder hidden layer dimension must be divisible by 8 for AMP training&quot;</span>

    <span class="c1"># restart from checkpoint</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load</span><span class="p">:</span>
        <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;Loading checkpoint from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">load</span><span class="p">))</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">optim</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">])</span>
        <span class="n">start_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">start_epoch</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;scaler&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;No GradScaler instance found in specified checkpoint; creating new GradScaler&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">start_epoch</span>

    <span class="c1"># parallelize</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">multigpu</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span><span class="si">}</span><span class="s1"> GPUs!&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Increasing batch size to </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">DataParallelPassthrough</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">multigpu</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: --multigpu selected, but </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span><span class="si">}</span><span class="s1"> GPUs detected&#39;</span><span class="p">)</span>

    <span class="c1"># train</span>
    <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;Done all preprocessing; starting training now!&#39;</span><span class="p">)</span>
    <span class="n">data_train_generator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span>
                                                       <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                       <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                       <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                                                       <span class="n">prefetch_factor</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefetch_factor</span><span class="p">,</span>
                                                       <span class="n">persistent_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">persistent_workers</span><span class="p">,</span>
                                                       <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_epoch</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">losses_accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">batch_it</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">batch_images</span><span class="p">,</span> <span class="n">batch_rots</span><span class="p">,</span> <span class="n">batch_trans</span><span class="p">,</span> <span class="n">batch_ctf_params</span><span class="p">,</span> <span class="n">batch_recon_error_weights</span><span class="p">,</span> <span class="n">batch_hartley_2d_mask</span><span class="p">,</span> <span class="n">batch_indices</span> <span class="ow">in</span> <span class="n">data_train_generator</span><span class="p">:</span>
            <span class="c1"># impression counting</span>
            <span class="n">batch_it</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_indices</span><span class="p">)</span>  <span class="c1"># total number of ptcls seen</span>
            <span class="n">global_it</span> <span class="o">=</span> <span class="n">nptcls</span> <span class="o">*</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">batch_it</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">beta_schedule</span><span class="p">(</span><span class="n">global_it</span><span class="p">)</span>

            <span class="c1"># transfer to GPU</span>
            <span class="n">batch_images</span> <span class="o">=</span> <span class="n">batch_images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">batch_rots</span> <span class="o">=</span> <span class="n">batch_rots</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">batch_trans</span> <span class="o">=</span> <span class="n">batch_trans</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">batch_ctf_params</span> <span class="o">=</span> <span class="n">batch_ctf_params</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">batch_recon_error_weights</span> <span class="o">=</span> <span class="n">batch_recon_error_weights</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">batch_hartley_2d_mask</span> <span class="o">=</span> <span class="n">batch_hartley_2d_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># training minibatch</span>
            <span class="n">losses_batch</span> <span class="o">=</span> <span class="n">train_batch</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                       <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span>
                                       <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
                                       <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                       <span class="n">batch_images</span><span class="o">=</span><span class="n">batch_images</span><span class="p">,</span>
                                       <span class="n">batch_rots</span><span class="o">=</span><span class="n">batch_rots</span><span class="p">,</span>
                                       <span class="n">batch_trans</span><span class="o">=</span><span class="n">batch_trans</span><span class="p">,</span>
                                       <span class="n">batch_ctf_params</span><span class="o">=</span><span class="n">batch_ctf_params</span><span class="p">,</span>
                                       <span class="n">batch_recon_error_weights</span><span class="o">=</span><span class="n">batch_recon_error_weights</span><span class="p">,</span>
                                       <span class="n">batch_hartley_2d_mask</span><span class="o">=</span><span class="n">batch_hartley_2d_mask</span><span class="p">,</span>
                                       <span class="n">image_ctf_premultiplied</span><span class="o">=</span><span class="n">image_ctf_premultiplied</span><span class="p">,</span>
                                       <span class="n">image_dose_weighted</span><span class="o">=</span><span class="n">image_dose_weighted</span><span class="p">,</span>
                                       <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
                                       <span class="n">beta_control</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">beta_control</span><span class="p">,</span>
                                       <span class="n">use_amp</span><span class="o">=</span><span class="n">use_amp</span><span class="p">)</span>

            <span class="c1"># logging</span>
            <span class="k">if</span> <span class="n">batch_it</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# [Train Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="si">}</span><span class="s1">] &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">batch_it</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">nptcls</span><span class="si">}</span><span class="s1"> subtomos] &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;gen loss=</span><span class="si">{</span><span class="n">losses_batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.15f</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;kld=</span><span class="si">{</span><span class="n">losses_batch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.15f</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;beta=</span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s1">.15f</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;loss=</span><span class="si">{</span><span class="n">losses_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.15f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">losses_accum</span> <span class="o">+=</span> <span class="n">losses_batch</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_images</span><span class="p">)</span>
        <span class="n">flog</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;# =====&gt; Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Average gen loss = </span><span class="si">{</span><span class="n">losses_accum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">batch_it</span><span class="si">:</span><span class="s1">.15f</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;KLD = </span><span class="si">{</span><span class="n">losses_accum</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">batch_it</span><span class="si">:</span><span class="s1">.15f</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;total loss = </span><span class="si">{</span><span class="n">losses_accum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">batch_it</span><span class="si">:</span><span class="s1">.15f</span><span class="si">}</span><span class="s1">; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Finished in </span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">checkpoint</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Memory usage: </span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">check_memory_usage</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_weights</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/weights.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">.pkl&#39;</span>
            <span class="n">out_z_train</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/z.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">.train.pkl&#39;</span>
            <span class="n">z_mu_train</span><span class="p">,</span> <span class="n">z_logvar_train</span> <span class="o">=</span> <span class="n">encoder_inference</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                                           <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                                           <span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
                                                           <span class="n">use_amp</span><span class="o">=</span><span class="n">use_amp</span><span class="p">,</span>
                                                           <span class="n">batchsize</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                           <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                                                           <span class="n">prefetch_factor</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefetch_factor</span><span class="p">,</span>
                                                           <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_test</span><span class="p">:</span>
                <span class="n">out_z_test</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/z.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">.test.pkl&#39;</span>
                <span class="n">z_mu_test</span><span class="p">,</span> <span class="n">z_logvar_test</span> <span class="o">=</span> <span class="n">encoder_inference</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                                             <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                                             <span class="n">data</span><span class="o">=</span><span class="n">data_test</span><span class="p">,</span>
                                                             <span class="n">use_amp</span><span class="o">=</span><span class="n">use_amp</span><span class="p">,</span>
                                                             <span class="n">batchsize</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                             <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                                                             <span class="n">prefetch_factor</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefetch_factor</span><span class="p">,</span>
                                                             <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z_mu_test</span><span class="p">,</span> <span class="n">z_logvar_test</span><span class="p">,</span> <span class="n">out_z_test</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span>
                            <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
                            <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
                            <span class="n">z_mu_train</span><span class="o">=</span><span class="n">z_mu_train</span><span class="p">,</span>
                            <span class="n">z_logvar_train</span><span class="o">=</span><span class="n">z_logvar_train</span><span class="p">,</span>
                            <span class="n">out_weights</span><span class="o">=</span><span class="n">out_weights</span><span class="p">,</span>
                            <span class="n">out_z_train</span><span class="o">=</span><span class="n">out_z_train</span><span class="p">,</span>
                            <span class="n">z_mu_test</span><span class="o">=</span><span class="n">z_mu_test</span><span class="p">,</span>
                            <span class="n">z_logvar_test</span><span class="o">=</span><span class="n">z_logvar_test</span><span class="p">,</span>
                            <span class="n">out_z_test</span><span class="o">=</span><span class="n">out_z_test</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_test</span><span class="p">:</span>
                <span class="n">flog</span><span class="p">(</span><span class="s1">&#39;Calculating convergence metrics using test/train split...&#39;</span><span class="p">)</span>
                <span class="n">convergence</span><span class="o">.</span><span class="n">calc_kld_two_gaussians</span><span class="p">(</span><span class="n">z_mu_train</span><span class="o">=</span><span class="n">z_mu_train</span><span class="p">,</span>
                                                   <span class="n">z_logvar_train</span><span class="o">=</span><span class="n">z_logvar_train</span><span class="p">,</span>
                                                   <span class="n">z_mu_test</span><span class="o">=</span><span class="n">z_mu_test</span><span class="p">,</span>
                                                   <span class="n">z_logvar_test</span><span class="o">=</span><span class="n">z_logvar_test</span><span class="p">,</span>
                                                   <span class="n">workdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                                                   <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
                <span class="n">convergence</span><span class="o">.</span><span class="n">generate_test_train_pair_volumes</span><span class="p">(</span><span class="n">z_train</span><span class="o">=</span><span class="n">z_mu_train</span><span class="p">,</span>
                                                             <span class="n">z_test</span><span class="o">=</span><span class="n">z_mu_test</span><span class="p">,</span>
                                                             <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
                                                             <span class="n">workdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                                                             <span class="n">volume_count</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">convergence</span><span class="o">.</span><span class="n">calc_test_train_pair_volumes_fscs</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                                                              <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
                <span class="n">convergence</span><span class="o">.</span><span class="n">calc_test_train_pair_volumes_cc_complement</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                                                                       <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>

    <span class="c1"># save model weights, latent encoding, and evaluate the model on 3D lattice</span>
    <span class="n">out_weights</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/weights.pkl&#39;</span>
    <span class="n">out_z_train</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/z.train.pkl&#39;</span>
    <span class="n">z_mu_train</span><span class="p">,</span> <span class="n">z_logvar_train</span> <span class="o">=</span> <span class="n">encoder_inference</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                                   <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                                   <span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
                                                   <span class="n">use_amp</span><span class="o">=</span><span class="n">use_amp</span><span class="p">,</span>
                                                   <span class="n">batchsize</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                   <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                                                   <span class="n">prefetch_factor</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefetch_factor</span><span class="p">,</span>
                                                   <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_test</span><span class="p">:</span>
        <span class="n">out_z_test</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/z.test.pkl&#39;</span>
        <span class="n">z_mu_test</span><span class="p">,</span> <span class="n">z_logvar_test</span> <span class="o">=</span> <span class="n">encoder_inference</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                                     <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                                     <span class="n">data</span><span class="o">=</span><span class="n">data_test</span><span class="p">,</span>
                                                     <span class="n">use_amp</span><span class="o">=</span><span class="n">use_amp</span><span class="p">,</span>
                                                     <span class="n">batchsize</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                     <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                                                     <span class="n">prefetch_factor</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefetch_factor</span><span class="p">,</span>
                                                     <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z_mu_test</span><span class="p">,</span> <span class="n">z_logvar_test</span><span class="p">,</span> <span class="n">out_z_test</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span>
                    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
                    <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
                    <span class="n">z_mu_train</span><span class="o">=</span><span class="n">z_mu_train</span><span class="p">,</span>
                    <span class="n">z_logvar_train</span><span class="o">=</span><span class="n">z_logvar_train</span><span class="p">,</span>
                    <span class="n">out_weights</span><span class="o">=</span><span class="n">out_weights</span><span class="p">,</span>
                    <span class="n">out_z_train</span><span class="o">=</span><span class="n">out_z_train</span><span class="p">,</span>
                    <span class="n">z_mu_test</span><span class="o">=</span><span class="n">z_mu_test</span><span class="p">,</span>
                    <span class="n">z_logvar_test</span><span class="o">=</span><span class="n">z_logvar_test</span><span class="p">,</span>
                    <span class="n">out_z_test</span><span class="o">=</span><span class="n">out_z_test</span><span class="p">)</span>
    <span class="n">td</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span>
    <span class="n">flog</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Finished in </span><span class="si">{</span><span class="n">td</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">td</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_epoch</span><span class="p">)</span><span class="si">}</span><span class="s1"> per epoch)&#39;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">add_args</span><span class="p">()</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, Barrett M Powell, Joseph H Davis.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>