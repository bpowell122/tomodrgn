
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tomodrgn.starfile &#8212; tomoDRGN 0.2.3.dev328 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../_static/documentation_options.js?v=d6c7774d"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/tomodrgn/starfile';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">tomoDRGN v0.2.3.dev328</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../overview/index.html">
    Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../command_usage/index.html">
    Command Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../overview/index.html">
    Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../command_usage/index.html">
    Command Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">tomodrgn.starfile</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for tomodrgn.starfile</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Lightweight parsers for starfiles</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">pairwise</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">get_args</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tomodrgn</span> <span class="kn">import</span> <span class="n">mrc</span><span class="p">,</span> <span class="n">utils</span>


<div class="viewcode-block" id="TiltSeriesStarfileStarHeaders">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfileStarHeaders.html#tomodrgn.starfile.TiltSeriesStarfileStarHeaders">[docs]</a>
<span class="k">class</span> <span class="nc">TiltSeriesStarfileStarHeaders</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enumeration of known source software with constituent data block names and headers which are compatible with the ``TiltSeriesStarfile`` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data_&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnMagnification&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDetectorPixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnVoltage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnSphericalAberration&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnPhaseShift&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusU&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusV&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusAngle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnMicrographName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleRot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleTilt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAnglePsi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCtfBfactor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCtfScalefactor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnRandomSubset&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnGroupName&#39;</span>
        <span class="p">],</span>
    <span class="p">}</span>
    <span class="n">cryosrpnt</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data_&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnImageName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDetectorPixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusU&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusV&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusAngle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnVoltage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnSphericalAberration&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnPhaseShift&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleRot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleTilt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAnglePsi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCtfBfactor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCtfScalefactor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnGroupName&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
    <span class="n">nextpyp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data_optics&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnOpticsGroupName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnMicrographOriginalPixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnVoltage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnSphericalAberration&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImagePixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageDimensionality&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;data_particles&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnImageName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnMicrographName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAnglePsi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleTilt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleRot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginXAngst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginYAngst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusU&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusV&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnDefocusAngle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnPhaseShift&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnGroupNumber&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCtfBfactor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCtfScalefactor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnLogLikeliContribution&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnRandomSubset&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTiltIndex&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="n">cistem</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data_&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_cisTEMPositionInStack&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMAnglePsi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMAngleTheta&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMAnglePhi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMXShift&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMYShift&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMDefocus1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMDefocus2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMDefocusAngle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMPhaseShift&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMOccupancy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMLogP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMSigma&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMScore&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMScoreChange&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMPixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMMicroscopeVoltagekV&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMMicroscopeCsMM&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMAmplitudeContrast&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMBeamTiltX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMBeamTiltY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMImageShiftX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMImageShiftY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMBest2DClass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMBeamTiltGroup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMParticleGroup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMPreExposure&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_cisTEMTotalExposure&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="TomoParticlesStarfileStarHeaders">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfileStarHeaders.html#tomodrgn.starfile.TomoParticlesStarfileStarHeaders">[docs]</a>
<span class="k">class</span> <span class="nc">TomoParticlesStarfileStarHeaders</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enumeration of known source software with constituent data block names and headers which are compatible with the ``TomoParticlesStarfile`` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warptools</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data_general&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnTomoSubTomosAre2DStacks&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;data_optics&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOpticsGroupName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnSphericalAberration&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnVoltage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoTiltSeriesPixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCtfDataAreCtfPremultiplied&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageDimensionality&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoSubtomogramBinning&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImagePixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;data_particles&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnTomoName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoParticleId&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateZ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleRot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleTilt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAnglePsi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoParticleName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginXAngst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginYAngst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginZAngst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoVisibleFrames&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="n">relion</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data_general&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnTomoSubTomosAre2DStacks&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;data_optics&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOpticsGroupName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnSphericalAberration&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnVoltage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoTiltSeriesPixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCtfDataAreCtfPremultiplied&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageDimensionality&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoSubtomogramBinning&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImagePixelSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageSize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;data_particles&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;_rlnTomoName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoParticleId&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnCoordinateZ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleRot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAngleTilt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnAnglePsi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoParticleName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnImageName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginXAngst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginYAngst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnOriginZAngst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnTomoVisibleFrames&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnGroupNumber&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnClassNumber&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnNormCorrection&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnRandomSubset&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnLogLikeliContribution&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnMaxValueProbDistribution&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_rlnNrOfSignificantSamples&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">}</span></div>



<span class="c1"># to avoid potential mistakes while repeating names of supported star file source software, dynamically define the Literal of allowable source software</span>
<span class="c1"># note that this does not work for static typing, but does work correctly at runtime (e.g. for building documentation)</span>
<span class="n">TILTSERIESSTARFILE_STAR_SOURCES</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;warp&#39;</span><span class="p">,</span> <span class="s1">&#39;cryosrpnt&#39;</span><span class="p">,</span> <span class="s1">&#39;nextpyp&#39;</span><span class="p">,</span> <span class="s1">&#39;cistem&#39;</span><span class="p">]</span>

<span class="n">TOMOPARTICLESSTARFILE_STAR_SOURCES</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;warptools&#39;</span><span class="p">,</span> <span class="s1">&#39;relion&#39;</span><span class="p">]</span>

<span class="n">KNOWN_STAR_SOURCES</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="n">TILTSERIESSTARFILE_STAR_SOURCES</span><span class="p">,</span> <span class="n">TOMOPARTICLESSTARFILE_STAR_SOURCES</span><span class="p">]</span>


<div class="viewcode-block" id="GenericStarfile">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.GenericStarfile.html#tomodrgn.starfile.GenericStarfile">[docs]</a>
<span class="k">class</span> <span class="nc">GenericStarfile</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to parse a STAR file, a pre-existing pandas dataframe, or a pre-existing dictionary, to a dictionary of dictionaries or pandas dataframes.</span>
<span class="sd">    Simple two-column STAR blocks are parsed as dictionaries, while complex table-style blocks are parsed as pandas dataframes.</span>

<span class="sd">    Notes:</span>

<span class="sd">    * Will ignore comments between `loop_` and beginning of data block; will not be preserved if using .write()</span>
<span class="sd">    * Will raise a RuntimeError if a comment is found within a data block initiated with `loop`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">starfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">dictionary</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the GenericStarfile object by reading a star file on disk, by passing in a pre-existing dictionary, or by passing in a pre-existing pandas dataframe.</span>

<span class="sd">        :param starfile: path to star file on disk, mutually exclusive with setting `dictionary` or `dataframe`</span>
<span class="sd">        :param dictionary: pre-existing python dictionary, mutually exclusive with setting `starfile` or `dataframe</span>
<span class="sd">        :param dataframe: pre-existing pandas dataframe, mutually exclusive with setting `starfile` or `dictionary`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">starfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">dataframe</span><span class="p">,</span> <span class="s1">&#39;Creating a GenericStarfile from a star file is mutually exclusive with creating a GenericStarfile from a dataframe.&#39;</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">dictionary</span><span class="p">,</span> <span class="s1">&#39;Creating a GenericStarfile from a star file is mutually exclusive with creating a GenericStarfile from a dictionary.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">starfile</span><span class="p">)</span>
            <span class="n">preambles</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skeletonize</span><span class="p">(</span><span class="n">sourcefile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preambles</span> <span class="o">=</span> <span class="n">preambles</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">blocks</span>
        <span class="k">elif</span> <span class="n">dictionary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">starfile</span><span class="p">,</span> <span class="s1">&#39;Creating a GenericStarfile from a dictionary is mutually exclusive with creating a GenericStarfile from a star file.&#39;</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">dataframe</span><span class="p">,</span> <span class="s1">&#39;Creating a GenericStarfile from a dictionary is mutually exclusive with creating a GenericStarfile from a dataframe.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preambles</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;data_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data_&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">dictionary</span>
        <span class="k">elif</span> <span class="n">dataframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">starfile</span><span class="p">,</span> <span class="s1">&#39;Creating a GenericStarfile from a dataframe is mutually exclusive with creating a GenericStarfile from a star file.&#39;</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">dictionary</span><span class="p">,</span> <span class="s1">&#39;Creating a GenericStarfile from a dataframe is mutually exclusive with creating a GenericStarfile from a dictionary.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preambles</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;data_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;loop_&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data_&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_&#39;</span><span class="p">:</span> <span class="n">dataframe</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_names</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_skeletonize</span><span class="p">(</span><span class="n">sourcefile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse star file for key data including:</span>

<span class="sd">        * preamble lines,</span>
<span class="sd">        * simple two-column blocks parsed as a dictionary, and</span>
<span class="sd">        * header lines, first, and last row numbers associated with each table-style data block.</span>

<span class="sd">        Does not load the entire file.</span>

<span class="sd">        :param sourcefile: path to star file on disk</span>
<span class="sd">        :return: preambles: list (for each data block) of lists (each line preceeding data block header lines and following data rows, as relevant)</span>
<span class="sd">        :return: blocks: dict mapping block names (e.g. `data_particles`) to either the block contents as a dictionary (for simple two-column data blocks),</span>
<span class="sd">                or to a list of constituent column headers (e.g. `_rlnImageName), and the first and last file lines containing data values of that block (for complex table-style blocks).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">parse_preamble</span><span class="p">(</span><span class="n">filehandle</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span>
                           <span class="n">_line_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Parse a star file preamble (the lines preceeding column header lines and following data rows, as relevant).</span>
<span class="sd">            Stop and return when the line initiating a data block is detected, or when end-of-file is detected</span>

<span class="sd">            :param filehandle: pre-existing file handle from which to read the star file</span>
<span class="sd">            :param _line_count: the currently active line number in the star file</span>
<span class="sd">            :return: _preamble: list of lines comprising the preamble section</span>
<span class="sd">            :return: _block_name: the name of the data block following the preamble section, or None if no data block follows</span>
<span class="sd">            :return: _line_count: the currently active line number in the star file after parsing the preamble</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># parse all lines preceeding column headers (including &#39;loop_&#39;)</span>
            <span class="n">_preamble</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">_line</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">_line_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_line</span><span class="p">:</span>
                    <span class="c1"># end of file detected</span>
                    <span class="k">return</span> <span class="n">_preamble</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_line_count</span>
                <span class="n">_preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data_&#39;</span><span class="p">):</span>
                    <span class="c1"># entering data block, potentially either simple block (to be parsed as dictionary) or loop block (to be parsed as pandas dataframe)</span>
                    <span class="n">_block_name</span> <span class="o">=</span> <span class="n">_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">_preamble</span><span class="p">,</span> <span class="n">_block_name</span><span class="p">,</span> <span class="n">_line_count</span>

        <span class="k">def</span> <span class="nf">parse_single_dictionary</span><span class="p">(</span><span class="n">_f</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span>
                                    <span class="n">_line_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                    <span class="n">_line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Parse and load a dictionary associated with a specific block name from a pre-existing file handle.</span>
<span class="sd">            The currently active line and all following lines (until a blank line or end of file) must have two values per line after splitting on white space.</span>
<span class="sd">            The first value becomes the dictionary key, and the second value becomes the dictionary value.</span>

<span class="sd">            :param _f: pre-existing file handle from which to read the star file</span>
<span class="sd">            :param _line_count: the currently active line number in the star file</span>
<span class="sd">            :param _line: the current line read from the star file, which begins with `_` as the text beginning the first key in the dictionary to be returned</span>
<span class="sd">            :return: dictionary: a dictionary of key:value per row&#39;s whitespace-delimited contents</span>
<span class="sd">            :return: _line_count: the currently active line number in the star file after parsing the data block</span>
<span class="sd">            :return: end_of_file: boolean indicating whether the entire file ends immediately following the data block</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># store the current line in the dictionary, where the current line is known to start with _ and therefore to be the first entry to the dictionary</span>
            <span class="n">key_val</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">_line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;The number of whitespace-delimited strings must be 2 to parse a simple STAR block, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">key_val</span><span class="p">)</span><span class="si">}</span><span class="s1"> for line </span><span class="si">{</span><span class="n">_line</span><span class="si">}</span><span class="s1"> at row </span><span class="si">{</span><span class="n">_line_count</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="n">key_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">key_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

            <span class="c1"># iterate through lines until blank line (end of STAR block) or no line (end of file) is reached</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">_line</span> <span class="o">=</span> <span class="n">_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">_line_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">_line</span><span class="p">:</span>
                    <span class="c1"># endo of data block, and end of file detected</span>
                    <span class="k">return</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">_line_count</span><span class="p">,</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="c1"># end of data block, not end of file</span>
                    <span class="k">return</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">_line_count</span><span class="p">,</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key_val</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">_line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;The number of whitespace-delimited strings must be 2 to parse a simple STAR block, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">key_val</span><span class="p">)</span><span class="si">}</span><span class="s1"> for line </span><span class="si">{</span><span class="n">_line</span><span class="si">}</span><span class="s1"> at row </span><span class="si">{</span><span class="n">_line_count</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">dictionary</span><span class="p">[</span><span class="n">key_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">key_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">parse_single_block</span><span class="p">(</span><span class="n">_f</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span>
                               <span class="n">_line_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Parse, but do not load, the rows defining a dataframe associated with a specific block name from a pre-existing file handle.</span>
<span class="sd">            The currently active line is `loop_` when entering this function, and therefore is not part of the dataframe (column names or body).</span>

<span class="sd">            :param _f: pre-existing file handle from which to read the star file</span>
<span class="sd">            :param _line_count: the currently active line number in the star file</span>
<span class="sd">            :return: _header: list of lines comprising the column headers of the data block</span>
<span class="sd">            :return: _block_start_line: the first file line containing the data values of the data block</span>
<span class="sd">            :return: _line_count: the currently active line number in the star file after parsing the data block</span>
<span class="sd">            :return: end_of_file: boolean indicating whether the entire file ends immediately following the data block</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">_header</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_block_start_line</span> <span class="o">=</span> <span class="n">_line_count</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># populate header</span>
                <span class="n">_line</span> <span class="o">=</span> <span class="n">_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">_line_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="c1"># blank line between `loop_` and first header row</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                    <span class="c1"># column header</span>
                    <span class="n">_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_line</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="c1"># line is a comment, discarding for now</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found comment at STAR file line </span><span class="si">{</span><span class="n">_line_count</span><span class="si">}</span><span class="s1">, will not be preserved if writing star file later&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">_line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">([</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">_header</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]):</span>
                    <span class="c1"># first data line</span>
                    <span class="n">_block_start_line</span> <span class="o">=</span> <span class="n">_line_count</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># unrecognized data block format</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># get length of data block</span>
                <span class="n">_line</span> <span class="o">=</span> <span class="n">_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">_line_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_line</span><span class="p">:</span>
                    <span class="c1"># end of file, therefore end of data block</span>
                    <span class="k">return</span> <span class="n">_header</span><span class="p">,</span> <span class="n">_block_start_line</span><span class="p">,</span> <span class="n">_line_count</span><span class="p">,</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="c1"># end of data block</span>
                    <span class="k">return</span> <span class="n">_header</span><span class="p">,</span> <span class="n">_block_start_line</span><span class="p">,</span> <span class="n">_line_count</span><span class="p">,</span> <span class="kc">False</span>

        <span class="n">preambles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sourcefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># iterates once per preamble/header/block combination, ends when parse_preamble detects EOF</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># file cursor is at the beginning of the file (first iteration) or at the end of a data_ block (subsequent iterations); parsing preamble of next data_ block</span>
                <span class="n">preamble</span><span class="p">,</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">line_count</span> <span class="o">=</span> <span class="n">parse_preamble</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">line_count</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span>
                    <span class="n">preambles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">block_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">preambles</span><span class="p">,</span> <span class="n">blocks</span>

                <span class="c1"># file cursor is at a `data_*` line; now parsing contents of this block from either simple block (as dictionary) or complex block (as pandas dataframe)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="n">line_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                        <span class="c1"># no loop_ detected, this is a simple STAR block</span>
                        <span class="n">block_dictionary</span><span class="p">,</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">end_of_file</span> <span class="o">=</span> <span class="n">parse_single_dictionary</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_dictionary</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;loop_&#39;</span><span class="p">):</span>
                        <span class="c1"># this is a complex block</span>
                        <span class="n">preambles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="n">header</span><span class="p">,</span> <span class="n">block_start_line</span><span class="p">,</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">end_of_file</span> <span class="o">=</span> <span class="n">parse_single_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">line_count</span><span class="p">)</span>
                        <span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">,</span> <span class="n">block_start_line</span><span class="p">,</span> <span class="n">line_count</span><span class="p">]</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># the data_ block contains no details and end of file reached</span>
                        <span class="n">end_of_file</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># treated as empty simple block</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># blank lines, comment lines, etc</span>
                        <span class="n">preambles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">end_of_file</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">preambles</span><span class="p">,</span> <span class="n">blocks</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">blocks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load each table-style data block of a pre-skeletonized star file into a pandas dataframe.</span>

<span class="sd">        :param blocks: dict mapping block names (e.g. `data_particles`) to a list of constituent column headers (e.g. `_rlnImageName),</span>
<span class="sd">            the first file line containing the data values of that block, and the last file line containing data values of that block</span>
<span class="sd">        :return: dict mapping block names (e.g. `data_particles`) to the corresponding data as a pandas dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">load_single_block</span><span class="p">(</span><span class="n">_header</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                              <span class="n">_block_start_line</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">_block_end_line</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Load a single data block of a pre-skeletonized star file into a pandas dataframe.</span>
<span class="sd">            Only needs to be called (and should only be called) on blocks containing complex STAR blocks that are to be loaded as pandas dataframes.</span>

<span class="sd">            :param _header: list of column headers (e.g. `_rlnImageName) of the data block</span>
<span class="sd">            :param _block_start_line: the first file line containing the data values of the data block</span>
<span class="sd">            :param _block_end_line: the last file line containing data values of the data block</span>
<span class="sd">            :return: pandas dataframe of the data block values</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">_header</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>

            <span class="c1"># load the first 1 row to get dtypes of columns</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span><span class="p">,</span>
                             <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span>  <span class="c1"># raw string to avoid syntaxwarnings when compiling documentation</span>
                             <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                             <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">skiprows</span><span class="o">=</span><span class="n">_block_start_line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">low_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
                             <span class="p">)</span>
            <span class="n">df_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="n">column</span><span class="p">:</span> <span class="n">dtype</span> <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())}</span>

            <span class="c1"># convert object dtype columns to string</span>
            <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">df_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                    <span class="n">df_dtypes</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">()</span>

            <span class="c1"># load the full dataframe with dtypes specified</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span><span class="p">,</span>
                             <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span>
                             <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                             <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">skiprows</span><span class="o">=</span><span class="n">_block_start_line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="n">nrows</span><span class="o">=</span><span class="n">_block_end_line</span> <span class="o">-</span> <span class="n">_block_start_line</span><span class="p">,</span>
                             <span class="n">low_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">df_dtypes</span><span class="p">,</span>
                             <span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">for</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="c1"># this is a simple STAR block and was loaded earlier during _skeletonize</span>
                <span class="c1"># or this is an empty block (i.e. a `data_` block was declared but no following rows were found)</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="c1"># this list describes the column headers, start row, and end row of a table-style block</span>
                <span class="n">header</span><span class="p">,</span> <span class="n">block_start_line</span><span class="p">,</span> <span class="n">block_end_line</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span>
                <span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_single_block</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">block_start_line</span><span class="p">,</span> <span class="n">block_end_line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown block type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">])</span><span class="si">}</span><span class="s1">; value of self.blocks[block_name] should be a python dictionary &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;or a list of defining rows to be parsed into a pandas dataframe&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blocks</span>

<div class="viewcode-block" id="GenericStarfile.write">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.GenericStarfile.html#tomodrgn.starfile.GenericStarfile.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">outstar</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">timestamp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out the starfile dataframe(s) as a new file</span>

<span class="sd">        :param outstar: name of the output star file, optionally as absolute or relative path</span>
<span class="sd">        :param timestamp: whether to include the timestamp of file creation as a comment in the first line of the file</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">write_single_block</span><span class="p">(</span><span class="n">_f</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span>
                               <span class="n">_block_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write a dataframe associated with a specific block name to a pre-existing file handle.</span>

<span class="sd">            :param _f: pre-existing file handle to which to write this block&#39;s contents</span>
<span class="sd">            :param _block_name: name of star file block to write (e.g. `data_`, `data_particles`)</span>
<span class="sd">            :return: None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">_block_name</span><span class="p">]</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s1"> #</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">header</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())]</span>
            <span class="n">_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>
            <span class="n">_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">_f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">write_single_dictionary</span><span class="p">(</span><span class="n">_f</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span>
                                    <span class="n">_block_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write a dictionary associated with a specific block name to a pre-existing file handle.</span>

<span class="sd">            :param _f: pre-existing file handle to which to write this block&#39;s contents</span>
<span class="sd">            :param _block_name: name of star file dictionary to write (e.g. `data_`)</span>
<span class="sd">            :return: None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">_block_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outstar</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Created </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>

            <span class="k">for</span> <span class="n">preamble</span><span class="p">,</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preambles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_names</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">preamble</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># check if block is dataframe or dictionary, separate writing methods for each</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">])</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
                    <span class="n">write_single_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">block_name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="n">write_single_dictionary</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">block_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown block type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">])</span><span class="si">}</span><span class="s1">; value of self.blocks[block_name] should be a python dictionary or a pandas dataframe&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrote </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">outstar</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GenericStarfile.get_particles_stack">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.GenericStarfile.html#tomodrgn.starfile.GenericStarfile.get_particles_stack">[docs]</a>
    <span class="k">def</span> <span class="nf">get_particles_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">particles_block_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">particles_path_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">datadir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">lazy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">mrc</span><span class="o">.</span><span class="n">LazyImage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load particle images referenced by starfile</span>

<span class="sd">        :param particles_block_name: name of star file block containing particle path column (e.g. `data_`, `data_particles`)</span>
<span class="sd">        :param particles_path_column: name of star file column containing path to particle images .mrcs (e.g. `_rlnImageName`)</span>
<span class="sd">        :param datadir: absolute path to particle images .mrcs to override particles_path_column</span>
<span class="sd">        :param lazy: whether to load particle images now in memory (False) or later on-the-fly (True)</span>
<span class="sd">        :return: np.ndarray of shape (n_ptcls * n_tilts, D, D) or list of LazyImage objects of length (n_ptcls * n_tilts)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># validate inputs</span>
        <span class="k">assert</span> <span class="n">particles_block_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">particles_path_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># group star file by mrcs file and get indices of each image within corresponding mrcs file</span>
        <span class="n">mrcs_files</span><span class="p">,</span> <span class="n">mrcs_grouped_image_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_image_inds_by_mrcs</span><span class="p">(</span><span class="n">particles_block_name</span><span class="o">=</span><span class="n">particles_block_name</span><span class="p">,</span>
                                                                             <span class="n">particles_path_column</span><span class="o">=</span><span class="n">particles_path_column</span><span class="p">)</span>

        <span class="c1"># confirm where to load MRC file(s) from disk</span>
        <span class="k">if</span> <span class="n">datadir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if star file contains relative paths to images, and star file is being loaded from other directory, try setting datadir to starfile abspath</span>
            <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span><span class="p">)</span>
        <span class="n">mrcs_files</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">prefix_paths</span><span class="p">(</span><span class="n">mrcs_files</span><span class="p">,</span> <span class="n">datadir</span><span class="p">)</span>

        <span class="c1"># identify key parameters for creating image data array using the first mrcs file</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">mrc</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">mrcs_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">boxsize</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">boxsize</span>  <span class="c1"># image size along one dimension in pixels</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># confirm that all mrcs files match this boxsize and dtype</span>
        <span class="k">for</span> <span class="n">mrcs_file</span> <span class="ow">in</span> <span class="n">mrcs_files</span><span class="p">:</span>
            <span class="n">_h</span> <span class="o">=</span> <span class="n">mrc</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">mrcs_file</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">boxsize</span> <span class="o">==</span> <span class="n">_h</span><span class="o">.</span><span class="n">boxsize</span>
            <span class="k">assert</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_h</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># calculate the number of bytes corresponding to one image in the mrcs files</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">boxsize</span> <span class="o">*</span> <span class="n">boxsize</span>

        <span class="k">if</span> <span class="n">lazy</span><span class="p">:</span>
            <span class="n">lazyparticles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mrc</span><span class="o">.</span><span class="n">LazyImage</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
                                           <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">),</span>
                                           <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                                           <span class="n">offset</span><span class="o">=</span><span class="n">header</span><span class="o">.</span><span class="n">total_header_bytes</span> <span class="o">+</span> <span class="n">ind_img</span> <span class="o">*</span> <span class="n">stride</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">ind_stack</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mrcs_grouped_image_inds</span><span class="p">,</span> <span class="n">mrcs_files</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">ind_img</span> <span class="ow">in</span> <span class="n">ind_stack</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">lazyparticles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># preallocating numpy array for in-place loading, fourier transform, fourier transform centering, etc.</span>
            <span class="c1"># allocating 1 extra pixel along x and y dimensions in anticipation of symmetrizing the hartley transform in-place</span>
            <span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">particles_block_name</span><span class="p">]),</span> <span class="n">boxsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boxsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">loaded_images</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ind_stack</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mrcs_grouped_image_inds</span><span class="p">,</span> <span class="n">mrcs_files</span><span class="p">):</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">loaded_images</span><span class="p">:</span><span class="n">loaded_images</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_stack</span><span class="p">),</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mrc</span><span class="o">.</span><span class="n">LazyImageStack</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
                                                                                                       <span class="n">indices_image</span><span class="o">=</span><span class="n">ind_stack</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">loaded_images</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_stack</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">particles</span></div>


    <span class="k">def</span> <span class="nf">_group_image_inds_by_mrcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">particles_block_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">particles_path_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Group the starfile `particles_path_column` by its referenced mrcs files, then by the indices of images referenced within those mrcs files, respecting star file row order.</span>

<span class="sd">        :param particles_block_name: name of star file block containing particle path column (e.g. `data_`, `data_particles`)</span>
<span class="sd">        :param particles_path_column: name of star file column containing path to particle images .mrcs (e.g. `_rlnImageName`)</span>
<span class="sd">        :return: mrcs_files: list of each mrcs path found in the star file that is unique from the preceeding row.</span>
<span class="sd">                 mrcs_grouped_image_inds: list of indices of images within the associated mrcs file which are referenced by the star file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the star file column containing the location of each image on disk</span>
        <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">particles_block_name</span><span class="p">][</span><span class="n">particles_path_column</span><span class="p">]</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>  <span class="c1"># assumed format is index@path_to_mrc</span>

        <span class="c1"># create new columns for 0-indexed image index and associated mrcs file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">particles_block_name</span><span class="p">][</span><span class="s1">&#39;_rlnImageNameInd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>  <span class="c1"># convert to 0-based indexing of full dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">particles_block_name</span><span class="p">][</span><span class="s1">&#39;_rlnImageNameBase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

        <span class="c1"># group image indices by associated mrcs file, respecting star file order</span>
        <span class="c1"># i.e. a mrcs file may be referenced discontinously in input star file, and should its images be separately grouped here</span>
        <span class="n">mrcs_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mrcs_grouped_image_inds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">particles_block_name</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">particles_block_name</span><span class="p">][</span><span class="s1">&#39;_rlnImageNameBase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">particles_block_name</span><span class="p">][</span><span class="s1">&#39;_rlnImageNameBase&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># mrcs_files = [path1, path2, ...]</span>
            <span class="n">mrcs_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;_rlnImageNameBase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># grouped_image_inds = [ [0, 1, 2, ..., N], [0, 3, 4, ..., M], ..., ]</span>
            <span class="n">mrcs_grouped_image_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;_rlnImageNameInd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">mrcs_files</span><span class="p">,</span> <span class="n">mrcs_grouped_image_inds</span>

<div class="viewcode-block" id="GenericStarfile.identify_particles_data_block">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.GenericStarfile.html#tomodrgn.starfile.GenericStarfile.identify_particles_data_block">[docs]</a>
    <span class="k">def</span> <span class="nf">identify_particles_data_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">column_substring</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Angle&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to identify the block_name of the data block within the star file for which rows refer to particle data (as opposed to optics or other data).</span>

<span class="sd">        :param column_substring: Search pattern to identify as substring within column name for particles block</span>
<span class="sd">        :return: the block name of the particles data block (e.g. `data` or `data_particles`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">block_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_names</span><span class="p">:</span>
            <span class="c1"># ignore any simple data blocks, which are stored as dictionaries</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">block_name</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reset to None, as this may be the last element of block_names, in which case the column_substring was not found, and we want to rase the error below</span>
                <span class="k">continue</span>

            <span class="c1"># find the dataframe containing particle data</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">pat</span><span class="o">=</span><span class="n">column_substring</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">block_name</span>
        <span class="k">if</span> <span class="n">block_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not identify block containing particle data in star file (by searching for column containing text </span><span class="si">{</span><span class="n">column_substring</span><span class="si">}</span><span class="s1">` in all blocks)&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TiltSeriesStarfile">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile">[docs]</a>
<span class="k">class</span> <span class="nc">TiltSeriesStarfile</span><span class="p">(</span><span class="n">GenericStarfile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to parse a particle image-series star file from upstream STA software.</span>
<span class="sd">    Each row in the star file must describe an individual image of a particle; groups of related rows describe all images observing one particle.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">starfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">source_software</span><span class="p">:</span> <span class="n">TILTSERIESSTARFILE_STAR_SOURCES</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="c1"># initialize object from parent class with parent attributes assigned at parent __init__</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">starfile</span><span class="p">)</span>

        <span class="c1"># pre-initialize header aliases as None, to be set as appropriate by guess_metadata_interpretation()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_phi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_theta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_psi</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx_angst</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty_angst</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_u</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_v</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_ang</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_cs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_w</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_dose</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tilt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_micrograph</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_image_random_split</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnRandomSubset&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_ctf_premultiplied</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dose_weighted</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_tilt_weighted</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ind_imgs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ind_ptcls</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ptcl_imgs</span> <span class="o">=</span> <span class="s1">&#39;unsorted&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_first_ntilts</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_first_nptcls</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcefile_filtered</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source_software</span> <span class="o">=</span> <span class="n">source_software</span>

        <span class="c1"># infer the upstream metadata format</span>
        <span class="k">if</span> <span class="n">source_software</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_infer_metadata_mapping</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">source_software</span> <span class="o">==</span> <span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warp_metadata_mapping</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">source_software</span> <span class="o">==</span> <span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">cryosrpnt</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryosrpnt_metadata_mapping</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">source_software</span> <span class="o">==</span> <span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">nextpyp</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nextpyp_metadata_mapping</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">source_software</span> <span class="o">==</span> <span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">cistem</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cistem_metadata_mapping</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized source_software </span><span class="si">{</span><span class="n">source_software</span><span class="si">}</span><span class="s1"> not one of known starfile sources for TiltSeriesStarfile </span><span class="si">{</span><span class="n">TILTSERIESSTARFILE_STAR_SOURCES</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_warp_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using STAR source software: </span><span class="si">{</span><span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># easy reference to particles data block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span> <span class="o">=</span> <span class="s1">&#39;data_&#39;</span>

        <span class="c1"># set header aliases used by tomodrgn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_phi</span> <span class="o">=</span> <span class="s1">&#39;_rlnAngleRot&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_theta</span> <span class="o">=</span> <span class="s1">&#39;_rlnAngleTilt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_psi</span> <span class="o">=</span> <span class="s1">&#39;_rlnAnglePsi&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginX&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginY&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span> <span class="o">=</span> <span class="s1">&#39;_rlnDetectorPixelSize&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_u</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusU&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_v</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusV&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_ang</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusAngle&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span> <span class="o">=</span> <span class="s1">&#39;_rlnVoltage&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_cs</span> <span class="o">=</span> <span class="s1">&#39;_rlnSphericalAberration&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_w</span> <span class="o">=</span> <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span> <span class="o">=</span> <span class="s1">&#39;_rlnPhaseShift&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span> <span class="o">=</span> <span class="s1">&#39;_rlnGroupName&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_dose</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnTotalDose&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tilt</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnPseudoStageTilt&#39;</span>  <span class="c1"># pseudo because arccos returns values in [0,pi] so lose +/- tilt information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span> <span class="o">=</span> <span class="s1">&#39;_rlnImageName&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_micrograph</span> <span class="o">=</span> <span class="s1">&#39;_rlnMicrographName&#39;</span>

        <span class="c1"># set additional headers needed by tomodrgn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_dose</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_rlnCtfBfactor&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="o">-</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tilt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_rlnCtfScalefactor&#39;</span><span class="p">])</span>

        <span class="c1"># image processing applied during particle extraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_ctf_premultiplied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dose_weighted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_tilt_weighted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_cryosrpnt_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using STAR source software: </span><span class="si">{</span><span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">cryosrpnt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># easy reference to particles data block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span> <span class="o">=</span> <span class="s1">&#39;data_&#39;</span>

        <span class="c1"># set header aliases used by tomodrgn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_phi</span> <span class="o">=</span> <span class="s1">&#39;_rlnAngleRot&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_theta</span> <span class="o">=</span> <span class="s1">&#39;_rlnAngleTilt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_psi</span> <span class="o">=</span> <span class="s1">&#39;_rlnAnglePsi&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginX&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginY&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span> <span class="o">=</span> <span class="s1">&#39;_rlnDetectorPixelSize&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_u</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusU&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_v</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusV&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_ang</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusAngle&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span> <span class="o">=</span> <span class="s1">&#39;_rlnVoltage&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_cs</span> <span class="o">=</span> <span class="s1">&#39;_rlnSphericalAberration&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_w</span> <span class="o">=</span> <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span> <span class="o">=</span> <span class="s1">&#39;_rlnPhaseShift&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span> <span class="o">=</span> <span class="s1">&#39;_rlnGroupName&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_dose</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnTotalDose&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tilt</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnPseudoStageTilt&#39;</span>  <span class="c1"># pseudo because arccos returns values in [0,pi] so lose +/- tilt information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span> <span class="o">=</span> <span class="s1">&#39;_rlnImageName&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_micrograph</span> <span class="o">=</span> <span class="s1">&#39;_rlnMicrographName&#39;</span>

        <span class="c1"># set additional headers needed by tomodrgn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_dose</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_rlnCtfBfactor&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="o">-</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tilt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_rlnCtfScalefactor&#39;</span><span class="p">])</span>

        <span class="c1"># image processing applied during particle extraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_ctf_premultiplied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dose_weighted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_tilt_weighted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_nextpyp_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using STAR source software: </span><span class="si">{</span><span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">nextpyp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># easy reference to particles data block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span> <span class="o">=</span> <span class="s1">&#39;data_optics&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span> <span class="o">=</span> <span class="s1">&#39;data_particles&#39;</span>

        <span class="c1"># set header aliases used by tomodrgn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_phi</span> <span class="o">=</span> <span class="s1">&#39;_rlnAngleRot&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_theta</span> <span class="o">=</span> <span class="s1">&#39;_rlnAngleTilt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_psi</span> <span class="o">=</span> <span class="s1">&#39;_rlnAnglePsi&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginX&#39;</span>  <span class="c1"># note: may not yet exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx_angst</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginXAngst&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginY&#39;</span>  <span class="c1"># note: may not yet exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty_angst</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginYAngst&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span> <span class="o">=</span> <span class="s1">&#39;_rlnImagePixelSize&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_u</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusU&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_v</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusV&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_ang</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusAngle&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span> <span class="o">=</span> <span class="s1">&#39;_rlnVoltage&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_cs</span> <span class="o">=</span> <span class="s1">&#39;_rlnSphericalAberration&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_w</span> <span class="o">=</span> <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span> <span class="o">=</span> <span class="s1">&#39;_rlnPhaseShift&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span> <span class="o">=</span> <span class="s1">&#39;_rlnGroupNumber&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_dose</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnTotalDose&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tilt</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnPseudoStageTilt&#39;</span>  <span class="c1"># pseudo because arccos returns values in [0,pi] so lose +/- tilt information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span> <span class="o">=</span> <span class="s1">&#39;_rlnImageName&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_micrograph</span> <span class="o">=</span> <span class="s1">&#39;_rlnMicrographName&#39;</span>

        <span class="c1"># merge optics groups block with particle data block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s1">&#39;many_to_one&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DROP&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^(?!.*_DROP)&#39;</span><span class="p">)</span>

        <span class="c1"># set additional headers needed by tomodrgn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_dose</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_rlnCtfBfactor&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="o">-</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tilt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_rlnCtfScalefactor&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx_angst</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty_angst</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">]</span>

        <span class="c1"># image processing applied during particle extraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_ctf_premultiplied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dose_weighted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_tilt_weighted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_cistem_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using STAR source software: </span><span class="si">{</span><span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">cistem</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_infer_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer particle source software and version for key metadata and extraction-time processing corrections</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">block_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_names</span><span class="p">}</span>
        <span class="k">match</span> <span class="n">headers</span><span class="p">:</span>

            <span class="k">case</span> <span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_warp_metadata_mapping</span><span class="p">()</span>

            <span class="k">case</span> <span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">cryosrpnt</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cryosrpnt_metadata_mapping</span><span class="p">()</span>

            <span class="k">case</span> <span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">nextpyp</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nextpyp_metadata_mapping</span><span class="p">()</span>

            <span class="k">case</span> <span class="n">TiltSeriesStarfileStarHeaders</span><span class="o">.</span><span class="n">cistem</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cistem_metadata_mapping</span><span class="p">()</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Auto detection of source software failed. &#39;</span>
                                          <span class="sa">f</span><span class="s1">&#39;Consider retrying with manually specified `source_software`.&#39;</span>
                                          <span class="sa">f</span><span class="s1">&#39;Found STAR file headers: </span><span class="si">{</span><span class="n">headers</span><span class="si">}</span><span class="s1">. &#39;</span>
                                          <span class="sa">f</span><span class="s1">&#39;TomoDRGN known STAR file headers: </span><span class="si">{</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">TiltSeriesStarfileStarHeaders</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to return headers associated with rotation parameters.</span>

<span class="sd">        :return: list of particles dataframe header names for rotations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_phi</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_theta</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_psi</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers_trans</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to return headers associated with translation parameters.</span>

<span class="sd">        :return: list of particles dataframe header names for translations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers_ctf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to return headers associated with CTF parameters.</span>

<span class="sd">        :return: list of particles dataframe header names for CTF parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_u</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_v</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_ang</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_cs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_w</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to access the particles dataframe associated with the TiltSeriesStarfile object.</span>

<span class="sd">        :return: pandas dataframe of particles metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span><span class="p">]</span>

    <span class="nd">@df</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
           <span class="n">value</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to update the particles dataframe associated with the TiltSeriesStarfile object</span>

<span class="sd">        :param value: modified particles dataframe</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of rows (images) in the particles dataframe associated with the TiltSeriesStarfile object.</span>

<span class="sd">        :return: the number of rows in the dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>

<div class="viewcode-block" id="TiltSeriesStarfile.get_tiltseries_pixelsize">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.get_tiltseries_pixelsize">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tiltseries_pixelsize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the pixel size of the extracted particles in ngstroms.</span>
<span class="sd">        Assumes all particles have the same pixel size.</span>

<span class="sd">        :return: pixel size in ngstroms/pixel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixel_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pixel_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: found multiple pixel sizes </span><span class="si">{</span><span class="n">pixel_sizes</span><span class="si">}</span><span class="s1"> in star file! &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; TomoDRGN does not support this for any volume-space reconstructions (e.g. backproject_voxel, train_vae).&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; Will use the most common pixel size </span><span class="si">{</span><span class="n">pixel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, but this will almost certainly lead to incorrect results.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pixel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="TiltSeriesStarfile.get_tiltseries_voltage">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.get_tiltseries_voltage">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tiltseries_voltage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the voltage of the microscope used to image the particles in kV.</span>

<span class="sd">        :return: voltage in kV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">voltages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">voltages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: found multiple voltages </span><span class="si">{</span><span class="n">voltages</span><span class="si">}</span><span class="s1"> in star file! &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; TomoDRGN does not support this for any volume-space reconstructions (e.g. backproject_voxel, train_vae).&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; Will use the most common voltage </span><span class="si">{</span><span class="n">voltages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, but this will almost certainly lead to incorrect results.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">voltages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="TiltSeriesStarfile.get_ptcl_img_indices">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.get_ptcl_img_indices">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ptcl_img_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the indices of each tilt image in the particles dataframe grouped by particle ID.</span>
<span class="sd">        The number of tilt images per particle may vary across the STAR file, so a list (or object-type numpy array or ragged torch tensor) is required</span>

<span class="sd">        :return: indices of each tilt image in the particles dataframe grouped by particle ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_grouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">df_grouped</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">ptcl</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">ptcl</span> <span class="ow">in</span> <span class="n">df_grouped</span><span class="o">.</span><span class="n">groups</span><span class="p">]</span></div>


<div class="viewcode-block" id="TiltSeriesStarfile.get_image_size">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.get_image_size">[docs]</a>
    <span class="k">def</span> <span class="nf">get_image_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">datadir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the image size in pixels by loading the first image&#39;s header.</span>
<span class="sd">        Assumes images are square.</span>

<span class="sd">        :param datadir: Relative or absolute path to overwrite path to particle image .mrcs specified in the STAR file</span>
<span class="sd">        :return: image size in pixels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># expected format of path to images .mrcs file is index@path_to_mrc, 1-indexed</span>
        <span class="n">first_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stack_index</span><span class="p">,</span> <span class="n">stack_path</span> <span class="o">=</span> <span class="n">first_image</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datadir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stack_path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">prefix_paths</span><span class="p">([</span><span class="n">stack_path</span><span class="p">],</span> <span class="n">datadir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stack_path</span><span class="si">}</span><span class="s1"> not found&#39;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">mrc</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">boxsize</span></div>


<div class="viewcode-block" id="TiltSeriesStarfile.filter">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.filter">[docs]</a>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">ind_imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">ind_ptcls</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">sort_ptcl_imgs</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;unsorted&#39;</span><span class="p">,</span> <span class="s1">&#39;dose_ascending&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unsorted&#39;</span><span class="p">,</span>
               <span class="n">use_first_ntilts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">use_first_nptcls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter the TiltSeriesStarfile in-place by image indices (rows) and particle indices (groups of rows corresponding to the same particle).</span>
<span class="sd">        Operations are applied in order: `ind_img -&gt; ind_ptcl -&gt; sort_ptcl_imgs -&gt; use_first_ntilts -&gt; use_first_nptcls`.</span>

<span class="sd">        :param ind_imgs: numpy array or path to numpy array of integer row indices to preserve, shape (N)</span>
<span class="sd">        :param ind_ptcls: numpy array or path to numpy array of integer particle indices to preserve, shape (N)</span>
<span class="sd">        :param sort_ptcl_imgs: sort the star file images on a per-particle basis by the specified criteria</span>
<span class="sd">        :param use_first_ntilts: keep the first `use_first_ntilts` images of each particle in the sorted star file.</span>
<span class="sd">                Default -1 means to use all. Will drop particles with fewer than this many tilt images.</span>
<span class="sd">        :param use_first_nptcls: keep the first `use_first_nptcls` particles in the sorted star file.</span>
<span class="sd">                Default -1 means to use all.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># save inputs as attributes of object for ease of future saving config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ind_imgs</span> <span class="o">=</span> <span class="n">ind_imgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ind_ptcls</span> <span class="o">=</span> <span class="n">ind_ptcls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ptcl_imgs</span> <span class="o">=</span> <span class="n">sort_ptcl_imgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_first_ntilts</span> <span class="o">=</span> <span class="n">use_first_ntilts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_first_nptcls</span> <span class="o">=</span> <span class="n">use_first_nptcls</span>

        <span class="c1"># how many particles does the star file initially contain</span>
        <span class="n">ptcls_unique_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ptcls_unique_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> particles in input star file&#39;</span><span class="p">)</span>

        <span class="c1"># assign unfiltered indices as column to allow easy downstream identification of preserved particle indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_UnfilteredParticleInds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">ngroup</span><span class="p">()</span>

        <span class="c1"># filter by image (row of dataframe) by presupplied indices</span>
        <span class="k">if</span> <span class="n">ind_imgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Filtering particle images by supplied indices&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind_imgs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pkl&#39;</span><span class="p">):</span>
                    <span class="n">ind_imgs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected .pkl file for </span><span class="si">{</span><span class="n">ind_imgs</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind_imgs</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># filter by particle (group of rows sharing common header_ptcl_uid) by presupplied indices</span>
        <span class="k">if</span> <span class="n">ind_ptcls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Filtering particles by supplied indices&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind_ptcls</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pkl&#39;</span><span class="p">):</span>
                    <span class="n">ind_ptcls</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected .pkl file for </span><span class="si">{</span><span class="n">ind_ptcls</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptcls_unique_list</span><span class="p">)</span>

            <span class="n">ptcls_unique_list</span> <span class="o">=</span> <span class="n">ptcls_unique_list</span><span class="p">[</span><span class="n">ind_ptcls</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ptcls_unique_list</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">),</span> <span class="s1">&#39;Make sure particle indices file does not contain duplicates&#39;</span>

        <span class="c1"># create temp mapping of input particle order in star file to preserve after sorting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_temp_input_ptcl_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">ngroup</span><span class="p">()</span>
        <span class="c1"># sort the star file per-particle by the specified method</span>
        <span class="k">if</span> <span class="n">sort_ptcl_imgs</span> <span class="o">!=</span> <span class="s1">&#39;unsorted&#39;</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sorting star file per-particle by </span><span class="si">{</span><span class="n">sort_ptcl_imgs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sort_ptcl_imgs</span> <span class="o">==</span> <span class="s1">&#39;dose_ascending&#39;</span><span class="p">:</span>
                <span class="c1"># sort by header_ptcl_uid first to keep images of the same particle together, then sort by header_ptcl_dose</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_temp_input_ptcl_order&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_dose</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sort_ptcl_imgs</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                <span class="c1"># group by header_ptcl_uid first to keep images of the same particle together, then shuffle rows within each group</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported value for </span><span class="si">{</span><span class="n">sort_ptcl_imgs</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># keep the first ntilts images of each particle</span>
        <span class="k">if</span> <span class="n">use_first_ntilts</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping first </span><span class="si">{</span><span class="n">use_first_ntilts</span><span class="si">}</span><span class="s1"> images of each particle. Excluding particles with fewer than this many images.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">use_first_ntilts</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># if a particledoes not have ntilts images, drop it</span>
            <span class="n">rows_to_drop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">use_first_ntilts</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">num_ptcls_to_drop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows_to_drop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">num_ptcls_to_drop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dropping </span><span class="si">{</span><span class="n">num_ptcls_to_drop</span><span class="si">}</span><span class="s1"> from star file due to having fewer than </span><span class="si">{</span><span class="n">use_first_ntilts</span><span class="si">=}</span><span class="s1"> tilt images per particle&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">rows_to_drop</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># keep the first nptcls particles</span>
        <span class="k">if</span> <span class="n">use_first_nptcls</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping first </span><span class="si">{</span><span class="n">use_first_nptcls</span><span class="si">=}</span><span class="s1"> particles.&#39;</span><span class="p">)</span>
            <span class="n">ptcls_unique_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">ptcls_unique_list</span> <span class="o">=</span> <span class="n">ptcls_unique_list</span><span class="p">[:</span><span class="n">use_first_nptcls</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ptcls_unique_list</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># order the final star file by input particle order, then by image indices in MRC file for contiguous file I/O</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span><span class="p">]]</span>  <span class="c1"># assumed format is index@path_to_mrc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_rlnImageNameInd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>  <span class="c1"># convert to 0-based indexing of full dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_temp_input_ptcl_order&#39;</span><span class="p">,</span> <span class="s1">&#39;_rlnImageNameInd&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;_temp_input_ptcl_order&#39;</span><span class="p">,</span> <span class="s1">&#39;_rlnImageNameInd&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TiltSeriesStarfile.make_test_train_split">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.make_test_train_split">[docs]</a>
    <span class="k">def</span> <span class="nf">make_test_train_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">fraction_split1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                              <span class="n">show_summary_stats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create indices for tilt images assigned to train vs test split.</span>
<span class="sd">        Images are randomly assigned to one set or the other by respecting `fraction_train` on a per-particle basis.</span>
<span class="sd">        Random split is stored in `self.df` under the `self.header_image_random_split` column.</span>

<span class="sd">        :param fraction_split1: fraction of each particle&#39;s tilt images to label split1. All others will be labeled split2.</span>
<span class="sd">        :param show_summary_stats: log distribution statistics of particle sampling for test/train splits</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check required inputs are present</span>
        <span class="n">df_grouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">fraction_split1</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>

        <span class="c1"># find minimum number of tilts present for any particle</span>
        <span class="n">mintilt_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_grouped</span><span class="p">:</span>
            <span class="n">mintilt_df</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="n">mintilt_df</span><span class="p">)</span>

        <span class="c1"># get indices associated with train and test</span>
        <span class="n">inds_train</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inds_test</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">particle_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_grouped</span><span class="p">:</span>
            <span class="c1"># get all image indices of this particle</span>
            <span class="n">inds_img</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="c1"># calculate the number of images to use in train split for this particle</span>
            <span class="n">n_inds_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds_img</span><span class="p">)</span> <span class="o">*</span> <span class="n">fraction_split1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="c1"># generate sorted indices for images in train split by sampling without replacement</span>
            <span class="n">inds_img_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">inds_img</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_inds_train</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">inds_img_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">inds_img_train</span><span class="p">)</span>
            <span class="n">inds_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_img_train</span><span class="p">)</span>

            <span class="c1"># assign all other images of this particle to the test split</span>
            <span class="n">inds_img_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inds_img</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">inds_img_train</span><span class="p">)))</span>
            <span class="n">inds_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_img_test</span><span class="p">)</span>

        <span class="c1"># provide summary statistics</span>
        <span class="k">if</span> <span class="n">show_summary_stats</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Number of tilts sampled by inds_train: </span><span class="si">{</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">inds_img_train</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">inds_img_train</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">inds_train</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Number of tilts sampled by inds_test: </span><span class="si">{</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">inds_img_test</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">inds_img_test</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">inds_test</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># flatten indices</span>
        <span class="n">inds_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ind_img</span> <span class="k">for</span> <span class="n">inds_img_train</span> <span class="ow">in</span> <span class="n">inds_train</span> <span class="k">for</span> <span class="n">ind_img</span> <span class="ow">in</span> <span class="n">inds_img_train</span><span class="p">])</span>
        <span class="n">inds_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ind_img</span> <span class="k">for</span> <span class="n">inds_img_test</span> <span class="ow">in</span> <span class="n">inds_test</span> <span class="k">for</span> <span class="n">ind_img</span> <span class="ow">in</span> <span class="n">inds_img_test</span><span class="p">])</span>

        <span class="c1"># sanity check: the intersection of inds_train and inds_test should be empty</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inds_train</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">inds_test</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inds_train</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">inds_test</span><span class="p">))</span>
        <span class="c1"># sanity check: the union of inds_train and inds_test should be the total number of images in the particles dataframe</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inds_train</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">inds_test</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inds_train</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">inds_test</span><span class="p">))</span>

        <span class="c1"># store random split in particles dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_image_random_split</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inds_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_image_random_split</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inds_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_image_random_split</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="TiltSeriesStarfile.plot_particle_uid_ntilt_distribution">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.plot_particle_uid_ntilt_distribution">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_particle_uid_ntilt_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                             <span class="n">outpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the distribution of the number of tilt images per particle as a line plot (against star file particle index) and as a histogram.</span>

<span class="sd">        :param outpath: file name to save the plot</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ptcls_to_imgs_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ptcl_img_indices</span><span class="p">()</span>
        <span class="n">ntilts_per_particle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ptcl_to_imgs_ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">ptcl_to_imgs_ind</span> <span class="ow">in</span> <span class="n">ptcls_to_imgs_ind</span><span class="p">])</span>
        <span class="n">ntilts</span><span class="p">,</span> <span class="n">counts_per_ntilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ntilts_per_particle</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ntilts_per_particle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;star file particle index&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ntilts per particle&#39;</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">ntilts</span><span class="p">,</span> <span class="n">counts_per_ntilt</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ntilts per particle&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="TiltSeriesStarfile.get_particles_stack">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.get_particles_stack">[docs]</a>
    <span class="k">def</span> <span class="nf">get_particles_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="o">*</span><span class="p">,</span>
                            <span class="n">datadir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">lazy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">mrc</span><span class="o">.</span><span class="n">LazyImage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls parent GenericStarfile get_particles_stack.</span>
<span class="sd">        Parent method parameters `particles_block_name` and `particles_path_column` are presupplied due to identification of these values during TiltSeriesStarfile instance creation.</span>

<span class="sd">        :param datadir: absolute path to particle images .mrcs to override particles_path_column</span>
<span class="sd">        :param lazy: whether to load particle images now in memory (False) or later on-the-fly (True)</span>
<span class="sd">        :return: np.ndarray of shape (n_ptcls * n_tilts, D, D) or list of LazyImage objects of length (n_ptcls * n_tilts)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_particles_stack</span><span class="p">(</span><span class="n">particles_block_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span><span class="p">,</span>
                                           <span class="n">particles_path_column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span><span class="p">,</span>
                                           <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span>
                                           <span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">)</span></div>


<div class="viewcode-block" id="TiltSeriesStarfile.write">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TiltSeriesStarfile.html#tomodrgn.starfile.TiltSeriesStarfile.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="o">*</span><span class="n">args</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Temporarily removes columns in data_particles dataframe that are present in data_optics dataframe (to restore expected input star file format), then calls parent GenericStarfile write.</span>

<span class="sd">        :param args: Passed to parent GenericStarfile write</span>
<span class="sd">        :param kwargs: Passed to parent GenericStarfile write</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># during loading TiltSeriesStarfile, block_optics and block_particles are merged for internal convenience when different upstream software either do or do not include data_optics block</span>
            <span class="n">columns_in_common</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="c1"># need to preserve the optics groups in the data_particles block</span>
            <span class="n">columns_in_common</span> <span class="o">=</span> <span class="n">columns_in_common</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">)</span>
            <span class="c1"># drop all other columns in common from the data_particles block</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns_in_common</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># now call parent write method</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># re-merge data_optics with data_particles so that the starfile object appears unchanged after calling this method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s1">&#39;many_to_one&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DROP&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^(?!.*_DROP)&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TomoParticlesStarfile">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile">[docs]</a>
<span class="k">class</span> <span class="nc">TomoParticlesStarfile</span><span class="p">(</span><span class="n">GenericStarfile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to parse a particle star file from upstream STA software.</span>
<span class="sd">    The input star file must be an optimisation set star file from e.g. WarpTools, RELION v5.</span>
<span class="sd">    The _rlnTomoParticlesFile referenced in the optimisation set must have each row describing a group of images observing a particular particle.</span>
<span class="sd">    This TomoParticlesStarfile is the object which is immediately loaded, though a reference to the parent optimisation set and related _lnTomoTomogramsFile are also stored</span>
<span class="sd">    (to reference TomoTomogramsStarfile if loading tomogram-level metadata, and to write a new optimisation set of modified the _rlnTomoParticlesFile contents).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">starfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">source_software</span><span class="p">:</span> <span class="n">TOMOPARTICLESSTARFILE_STAR_SOURCES</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="c1"># the input star file is the optimisation set; store its path and contents for future writing</span>
        <span class="k">assert</span> <span class="n">is_starfile_optimisation_set</span><span class="p">(</span><span class="n">starfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">starfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star</span> <span class="o">=</span> <span class="n">GenericStarfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star_path</span><span class="p">)</span>

        <span class="c1"># the input star also references a TomoTomogramsFile; store its path and contents for future reference</span>
        <span class="n">tomograms_star_rel_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;data_&#39;</span><span class="p">][</span><span class="s1">&#39;_rlnTomoTomogramsFile&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">tomograms_star_rel_path</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">tomograms_star_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star_path</span><span class="p">),</span> <span class="n">tomograms_star_rel_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star_path</span> <span class="o">=</span> <span class="n">tomograms_star_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span> <span class="o">=</span> <span class="n">GenericStarfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star_path</span><span class="p">)</span>

        <span class="c1"># initialize the main TomoParticlesStarfile object from the _rlnTomoParticlesFile header</span>
        <span class="n">ptcls_star_rel_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;data_&#39;</span><span class="p">][</span><span class="s1">&#39;_rlnTomoParticlesFile&#39;</span><span class="p">]</span>
        <span class="n">ptcls_star_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star_path</span><span class="p">),</span> <span class="n">ptcls_star_rel_path</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ptcls_star_path</span><span class="p">)</span>

        <span class="c1"># override the sourcefile attribute set by parent init to point to the optimisation set, since that is the file that must be passed to re-load this object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star_path</span>

        <span class="c1"># check that the particles star file references 2D image stacks</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;data_general&#39;</span><span class="p">][</span><span class="s1">&#39;_rlnTomoSubTomosAre2DStacks&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;TomoDRGN is only compatible with tilt series particles extracted as 2D image stacks.&#39;</span>

        <span class="c1"># pre-initialize header aliases as None, to be set as appropriate by _infer_metadata_mapping()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_phi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_theta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_psi</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx_angst</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty_angst</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_u</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_v</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_ang</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_cs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_w</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_coord_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_coord_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_coord_z</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_micrograph</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_random_split</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_image_random_split</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnRandomSubset&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_ctf_premultiplied</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dose_weighted</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_tilt_weighted</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ind_imgs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ind_ptcls</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ptcl_imgs</span> <span class="o">=</span> <span class="s1">&#39;unsorted&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_first_ntilts</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_first_nptcls</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcefile_filtered</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source_software</span> <span class="o">=</span> <span class="n">source_software</span>

        <span class="c1"># infer the upstream metadata format</span>
        <span class="k">if</span> <span class="n">source_software</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_infer_metadata_mapping</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">source_software</span> <span class="o">==</span> <span class="n">TomoParticlesStarfileStarHeaders</span><span class="o">.</span><span class="n">warptools</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using STAR source software: </span><span class="si">{</span><span class="n">TomoParticlesStarfileStarHeaders</span><span class="o">.</span><span class="n">warptools</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warptools_metadata_mapping</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">source_software</span> <span class="o">==</span> <span class="n">TomoParticlesStarfileStarHeaders</span><span class="o">.</span><span class="n">relion</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using STAR source software: </span><span class="si">{</span><span class="n">TomoParticlesStarfileStarHeaders</span><span class="o">.</span><span class="n">relion</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_relion_metadata_mapping</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized source_software </span><span class="si">{</span><span class="n">source_software</span><span class="si">}</span><span class="s1"> not one of known starfile sources for TomoParticlesStarfile </span><span class="si">{</span><span class="n">TOMOPARTICLESSTARFILE_STAR_SOURCES</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_warptools_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># in the examples I have seen so far, the warptools metadata and relion metadata are equivalent for the fields required by tomodrgn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relion_metadata_mapping</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_relion_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TomoParticlesStarfile optics block and contents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span> <span class="o">=</span> <span class="s1">&#39;data_optics&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span> <span class="o">=</span> <span class="s1">&#39;_rlnImagePixelSize&#39;</span>

        <span class="c1"># TomoParticlesStarfile particles block and contents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span> <span class="o">=</span> <span class="s1">&#39;data_particles&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_phi</span> <span class="o">=</span> <span class="s1">&#39;_rlnAngleRot&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_theta</span> <span class="o">=</span> <span class="s1">&#39;_rlnAngleTilt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_psi</span> <span class="o">=</span> <span class="s1">&#39;_rlnAnglePsi&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx_angst</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginXAngst&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty_angst</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginYAngst&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tz_angst</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginZAngst&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginX&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginY&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tz</span> <span class="o">=</span> <span class="s1">&#39;_rlnOriginZ&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_coord_x</span> <span class="o">=</span> <span class="s1">&#39;_rlnCoordinateX&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_coord_y</span> <span class="o">=</span> <span class="s1">&#39;_rlnCoordinateY&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_coord_z</span> <span class="o">=</span> <span class="s1">&#39;_rlnCoordinateZ&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_uid</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span> <span class="o">=</span> <span class="s1">&#39;_rlnImageName&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tomogram</span> <span class="o">=</span> <span class="s1">&#39;_rlnTomoName&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_random_split</span> <span class="o">=</span> <span class="s1">&#39;_rlnRandomSubset&#39;</span>  <span class="c1"># used for random split per-particle (e.g. from RELION)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_image_random_split</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnRandomSubset&#39;</span>  <span class="c1"># used for random split per-particle-image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span> <span class="o">=</span> <span class="s1">&#39;_rlnTomoVisibleFrames&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_box_size</span> <span class="o">=</span> <span class="s1">&#39;_rlnImageSize&#39;</span>

        <span class="c1"># TomoTomogramsStarfile global block and contents -- NOT accessible from this class directly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span> <span class="o">=</span> <span class="s1">&#39;_rlnVoltage&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_cs</span> <span class="o">=</span> <span class="s1">&#39;_rlnSphericalAberration&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_w</span> <span class="o">=</span> <span class="s1">&#39;_rlnAmplitudeContrast&#39;</span>

        <span class="c1"># TomoTomogramsStarfile TOMOGRAM_NAME block and contents -- NOT accessible from this class directly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_proj_x</span> <span class="o">=</span> <span class="s1">&#39;_rlnTomoProjX&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_proj_y</span> <span class="o">=</span> <span class="s1">&#39;_rlnTomoProjY&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_proj_z</span> <span class="o">=</span> <span class="s1">&#39;_rlnTomoProjZ&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_proj_w</span> <span class="o">=</span> <span class="s1">&#39;_rlnTomoProjW&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_u</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusU&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_v</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusV&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_ang</span> <span class="o">=</span> <span class="s1">&#39;_rlnDefocusAngle&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span> <span class="o">=</span> <span class="s1">&#39;_rlnPhaseShift&#39;</span>  <span class="c1"># potentially not created yet</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_dose</span> <span class="o">=</span> <span class="s1">&#39;_rlnMicrographPreExposure&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_tilt</span> <span class="o">=</span> <span class="s1">&#39;_tomodrgnPseudoStageTilt&#39;</span>  <span class="c1"># pseudo because arccos returns values in [0,pi] so lose +/- tilt information</span>

        <span class="c1"># merge optics groups block with particle data block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s1">&#39;many_to_one&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DROP&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^(?!.*_DROP)&#39;</span><span class="p">)</span>

        <span class="c1"># set additional headers needed by tomodrgn</span>
        <span class="k">for</span> <span class="n">tomo_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tomogram</span><span class="p">]:</span>
            <span class="c1"># create a temporary column with values of stage tilt in radians</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_tilt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;_rlnCtfScalefactor&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx_angst</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty_angst</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tz</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tz_angst</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># convert the _rlnTomoVisibleFrames column from default dtype inferred by pandas (str of list of int, e.g. &#39;[1,1,0,1,...]&#39; to numpy array of ints</span>
        <span class="c1"># more efficient (though less robust) than ast.literal_eval because we know the data structure ahead of time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">include</span> <span class="k">for</span> <span class="n">include</span> <span class="ow">in</span> <span class="n">ptcl_frames</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                                                    <span class="k">for</span> <span class="n">ptcl_frames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]]</span>

        <span class="c1"># convert the _rlnTomoProj{X,Y,Z,W} columns from default dtype inferred by pandas (str of list of float, e.g. &#39;[1.0,0.0,0.0,0]&#39; to numpy array of floats</span>
        <span class="k">for</span> <span class="n">tomogram_block_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">block_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tomogram_block_name</span> <span class="o">==</span> <span class="s1">&#39;data_global&#39;</span><span class="p">:</span>
                <span class="c1"># this is global data block, no projection matrices to convert</span>
                <span class="k">continue</span>
            <span class="n">df_tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">tomogram_block_name</span><span class="p">]</span>
            <span class="n">projection_matrices_headers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_proj_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_proj_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_proj_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_proj_w</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">projection_matrices_header</span> <span class="ow">in</span> <span class="n">projection_matrices_headers</span><span class="p">:</span>
                <span class="n">df_tomo</span><span class="p">[</span><span class="n">projection_matrices_header</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">proj_element</span> <span class="k">for</span> <span class="n">proj_element</span> <span class="ow">in</span> <span class="n">tilt_proj</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                                                       <span class="k">for</span> <span class="n">tilt_proj</span> <span class="ow">in</span> <span class="n">df_tomo</span><span class="p">[</span><span class="n">projection_matrices_header</span><span class="p">]]</span>

        <span class="c1"># image processing applied during particle extraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_ctf_premultiplied</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span><span class="p">][</span><span class="s1">&#39;_rlnCtfDataAreCtfPremultiplied&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dose_weighted</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># warptools applie fixed exposure weights per-frequency for each extracted image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_tilt_weighted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># note columns added during init, so that we can remove these columns later when writing the star file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomodrgn_added_headers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_infer_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer particle source software and version for key metadata and extraction-time processing corrections</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">block_name</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">])</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                   <span class="k">for</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_names</span><span class="p">}</span>
        <span class="k">match</span> <span class="n">headers</span><span class="p">:</span>

            <span class="k">case</span> <span class="n">TomoParticlesStarfileStarHeaders</span><span class="o">.</span><span class="n">warptools</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using STAR source software: </span><span class="si">{</span><span class="n">TomoParticlesStarfileStarHeaders</span><span class="o">.</span><span class="n">warptools</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_warptools_metadata_mapping</span><span class="p">()</span>

            <span class="k">case</span> <span class="n">TomoParticlesStarfileStarHeaders</span><span class="o">.</span><span class="n">relion</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using STAR source software: </span><span class="si">{</span><span class="n">TomoParticlesStarfileStarHeaders</span><span class="o">.</span><span class="n">relion</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relion_metadata_mapping</span><span class="p">()</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Auto detection of source software failed. &#39;</span>
                                          <span class="sa">f</span><span class="s1">&#39;Consider retrying with manually specified `source_software`.&#39;</span>
                                          <span class="sa">f</span><span class="s1">&#39;Found STAR file headers: </span><span class="si">{</span><span class="n">headers</span><span class="si">}</span><span class="s1">. &#39;</span>
                                          <span class="sa">f</span><span class="s1">&#39;TomoDRGN known STAR file headers: </span><span class="si">{</span><span class="n">TomoParticlesStarfileStarHeaders</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to return headers associated with rotation parameters.</span>

<span class="sd">        :return: list of particles dataframe header names for rotations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_phi</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_theta</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_psi</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers_trans</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to return headers associated with translation parameters.</span>

<span class="sd">        :return: list of particles dataframe header names for translations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tx</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_ty</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_pose_tz</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers_ctf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to return headers associated with CTF parameters.</span>

<span class="sd">        :return: list of particles dataframe header names for CTF parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_u</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_v</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_defocus_ang</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_cs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_w</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_ps</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to access the particles dataframe associated with the TomoParticlesStarfile object.</span>

<span class="sd">        :return: pandas dataframe of particles metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span><span class="p">]</span>

    <span class="nd">@df</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
           <span class="n">value</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to update the particles dataframe associated with the TomoParticlesStarfile object</span>

<span class="sd">        :param value: modified particles dataframe</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_particles</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="TomoParticlesStarfile.get_tiltseries_pixelsize">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile.get_tiltseries_pixelsize">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tiltseries_pixelsize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the pixel size of the extracted particles in ngstroms.</span>
<span class="sd">        Assumes all particles have the same pixel size.</span>

<span class="sd">        :return: pixel size in ngstroms/pixel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixel_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_angpix</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pixel_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: found multiple pixel sizes </span><span class="si">{</span><span class="n">pixel_sizes</span><span class="si">}</span><span class="s1"> in star file! &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; TomoDRGN does not support this for any volume-space reconstructions (e.g. backproject_voxel, train_vae).&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; Will use the most common pixel size </span><span class="si">{</span><span class="n">pixel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, but this will almost certainly lead to incorrect results.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pixel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="TomoParticlesStarfile.get_tiltseries_voltage">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile.get_tiltseries_voltage">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tiltseries_voltage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the voltage of the microscope used to image the particles in kV.</span>

<span class="sd">        :return: voltage in kV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">voltages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ctf_voltage</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">voltages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: found multiple voltages </span><span class="si">{</span><span class="n">voltages</span><span class="si">}</span><span class="s1"> in star file! &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; TomoDRGN does not support this for any volume-space reconstructions (e.g. backproject_voxel, train_vae).&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; Will use the most common voltage </span><span class="si">{</span><span class="n">voltages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, but this will almost certainly lead to incorrect results.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">voltages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="TomoParticlesStarfile.get_ptcl_img_indices">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile.get_ptcl_img_indices">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ptcl_img_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the indices of each tilt image and associated metadata relative to the pre-filtered subset of all images of all particles in the star file.</span>
<span class="sd">        Filtering is done using the ``self.header_ptcl_visible_frames`` column.</span>
<span class="sd">        For example, using the first two dataframe rows of this column as ``[[1,1,0,1],[1,0,0,1]]``, this method would return indices ``[np.array([0,1,2]), np.array([3,4])]``.</span>
<span class="sd">        The number of tilt images per particle may vary across the STAR file, so returning a list (or object-type numpy array or ragged torch tensor) is required.</span>

<span class="sd">        :return: integer indices of each tilt image in the particles dataframe grouped by particle ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">images_per_ptcl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>  <span class="c1"># array of number of included images per particle</span>
        <span class="n">cumulative_images_per_ptcl</span> <span class="o">=</span> <span class="n">images_per_ptcl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>  <span class="c1"># array of cumulative number of included images throughout entire dataframe</span>
        <span class="n">cumulative_images_per_ptcl</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ptcl_to_img_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">cumulative_images_per_ptcl</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ptcl_to_img_indices</span></div>


    <span class="k">def</span> <span class="nf">get_image_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="TomoParticlesStarfile.filter">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile.filter">[docs]</a>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">ind_imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">ind_ptcls</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">sort_ptcl_imgs</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;unsorted&#39;</span><span class="p">,</span> <span class="s1">&#39;dose_ascending&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unsorted&#39;</span><span class="p">,</span>
               <span class="n">use_first_ntilts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">use_first_nptcls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter the TomoParticlesStarfile in-place by image indices (e.g., datafram _rlnTomoVisibleFrames column) and particle indices (dataframe rows).</span>
<span class="sd">        Operations are applied in order: `ind_img -&gt; ind_ptcl -&gt; sort_ptcl_imgs -&gt; use_first_ntilts -&gt; use_first_nptcls`.</span>

<span class="sd">        :param ind_imgs: numpy array or path to numpy array of integer images to preserve, shape (nimgs),</span>
<span class="sd">                Sets values in the _rlnTomoVisibleFrames column to 0 if that image&#39;s index is not in ind_imgs.</span>
<span class="sd">        :param ind_ptcls: numpy array or path to numpy array of integer particle indices to preserve, shape (nptcls).</span>
<span class="sd">                Drops particles from the dataframe if that particle&#39;s index is not in ind_ptcls.</span>
<span class="sd">        :param sort_ptcl_imgs: sort the star file images on a per-particle basis by the specified criteria.</span>
<span class="sd">                This is primarily useful in combination with ``use_first_ntilts`` to get the first ``ntilts`` images of each particle after sorting.</span>
<span class="sd">        :param use_first_ntilts: keep the first `use_first_ntilts` images (of those images previously marked to be included by _rlnTomoVisibleFrames) of each particle in the sorted star file.</span>
<span class="sd">                Default -1 means to use all. Will drop particles with fewer than this many tilt images.</span>
<span class="sd">        :param use_first_nptcls: keep the first `use_first_nptcls` particles in the sorted star file.</span>
<span class="sd">                Default -1 means to use all.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># save inputs as attributes of object for ease of future saving config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ind_imgs</span> <span class="o">=</span> <span class="n">ind_imgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ind_ptcls</span> <span class="o">=</span> <span class="n">ind_ptcls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ptcl_imgs</span> <span class="o">=</span> <span class="n">sort_ptcl_imgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_first_ntilts</span> <span class="o">=</span> <span class="n">use_first_ntilts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_first_nptcls</span> <span class="o">=</span> <span class="n">use_first_nptcls</span>

        <span class="c1"># how many particles does the star file initially contain</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s1"> particles in input star file&#39;</span><span class="p">)</span>

        <span class="c1"># filter by image (element of _rlnTomoVisibleFrames list per row) by presupplied indices</span>
        <span class="k">if</span> <span class="n">ind_imgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Filtering particle images by supplied indices&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind_imgs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pkl&#39;</span><span class="p">):</span>
                    <span class="n">ind_imgs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected .pkl file for </span><span class="si">{</span><span class="n">ind_imgs</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;The minimum allowable image index is 0&#39;</span>
            <span class="n">nimgs_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nimgs_total</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;The maximum allowable image index is the total number of images referenced in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">nimgs_total</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">unique_ind_imgs</span><span class="p">,</span> <span class="n">unique_ind_imgs_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">unique_ind_imgs_counts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Repeated image indices are not allowed, found the following repeated image indices: </span><span class="si">{</span><span class="n">unique_ind_imgs</span><span class="p">[</span><span class="n">unique_ind_imgs_counts</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="n">ind_imgs_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nimgs_total</span><span class="p">)</span>
            <span class="n">ind_imgs_mask</span><span class="p">[</span><span class="n">ind_imgs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">masked_visible_frames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ind_img_cursor</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]:</span>
                <span class="c1"># get the number of images in this image as the window width to draw from the ind_imgs_mask</span>
                <span class="n">imgs_this_ptcl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptcl_visible_frames</span><span class="p">)</span>
                <span class="c1"># only preserve images that were both initially marked 1 and are selected by ind_imgs</span>
                <span class="n">masked_ptcl_visible_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ptcl_visible_frames</span><span class="p">,</span> <span class="n">ind_imgs_mask</span><span class="p">[</span><span class="n">ind_img_cursor</span><span class="p">:</span> <span class="n">ind_img_cursor</span> <span class="o">+</span> <span class="n">imgs_this_ptcl</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="c1"># append to an overall list for all particles</span>
                <span class="n">masked_visible_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masked_ptcl_visible_frames</span><span class="p">)</span>
                <span class="c1"># increment the global image index offset by the number of images in this particle so that the next iteration&#39;s particle is correctly masked</span>
                <span class="n">ind_img_cursor</span> <span class="o">+=</span> <span class="n">imgs_this_ptcl</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_visible_frames</span>

        <span class="c1"># filter by particle (df row) by presupplied indices</span>
        <span class="k">if</span> <span class="n">ind_ptcls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Filtering particles by supplied indices&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind_ptcls</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pkl&#39;</span><span class="p">):</span>
                    <span class="n">ind_ptcls</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected .pkl file for </span><span class="si">{</span><span class="n">ind_ptcls</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="n">ind_ptcls</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="n">unique_ind_ptcls</span><span class="p">,</span> <span class="n">unique_ind_ptcls_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind_imgs</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">unique_ind_ptcls_counts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Repeated particle indices are not allowed, found the following repeated particle indices: </span><span class="si">{</span><span class="n">unique_ind_ptcls</span><span class="p">[</span><span class="n">unique_ind_ptcls_counts</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind_ptcls</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># sort the star file per-particle by the specified method</span>
        <span class="k">if</span> <span class="n">sort_ptcl_imgs</span> <span class="o">!=</span> <span class="s1">&#39;unsorted&#39;</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sorting star file per-particle by </span><span class="si">{</span><span class="n">sort_ptcl_imgs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sorted_visible_frames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># apply sorting to TomoTomogramsStarfile by sorting rows per-tomogram-block, then apply updated tilt indexing to TomoParticlesStarfile header_ptcl_visible_frames to keep metadata in sync</span>
            <span class="k">for</span> <span class="n">tomo_name</span><span class="p">,</span> <span class="n">ptcl_group_df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tomogram</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">sort_ptcl_imgs</span> <span class="o">==</span> <span class="s1">&#39;dose_ascending&#39;</span><span class="p">:</span>
                    <span class="c1"># sort the tilts of this tomo by dose</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header_tomo_dose</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sort_ptcl_imgs</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                    <span class="c1"># sort the tilts of this tomo randomly</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported value for </span><span class="si">{</span><span class="n">sort_ptcl_imgs</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># update the ordering of images via header_ptcl_visible_frames to match the corresponding tomogram df index</span>
                <span class="n">reordered_tilts_this_tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="n">ptcl_group_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]:</span>
                    <span class="c1"># reindex this image&#39;s visible frames</span>
                    <span class="n">sorted_ptcl_visible_frames</span> <span class="o">=</span> <span class="n">ptcl_visible_frames</span><span class="p">[</span><span class="n">reordered_tilts_this_tomo</span><span class="p">]</span>
                    <span class="c1"># recast this array of ints to the same input format (str of list) and append to an overall list for all particles</span>
                    <span class="n">sorted_visible_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sorted_ptcl_visible_frames</span><span class="p">)</span>

            <span class="c1"># update the particles df header_ptcl_visible_frames to the newly sorted visible_frames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorted_visible_frames</span>

        <span class="c1"># keep the first ntilts images of each particle</span>
        <span class="k">if</span> <span class="n">use_first_ntilts</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping first </span><span class="si">{</span><span class="n">use_first_ntilts</span><span class="si">}</span><span class="s1"> images of each particle. Excluding particles with fewer than this many images.&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">use_first_ntilts</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="n">particles_to_drop_insufficient_tilts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">masked_visible_frames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ind_ptcl</span><span class="p">,</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]):</span>
                <span class="c1"># preserve the first use_first_ntilts frames that are already marked include (1); set the remainder to not include (0)</span>
                <span class="n">cumulative_ptcl_visible_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ptcl_visible_frames</span><span class="p">)</span>
                <span class="n">masked_ptcl_visible_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cumulative_ptcl_visible_frames</span> <span class="o">&lt;=</span> <span class="n">use_first_ntilts</span><span class="p">,</span>
                                                      <span class="n">ptcl_visible_frames</span><span class="p">,</span>
                                                      <span class="mi">0</span><span class="p">)</span>

                <span class="c1"># check how many images are now included for this particle; add this particle to the list to be dropped if fewer than use_first_ntilts</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">masked_ptcl_visible_frames</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">use_first_ntilts</span><span class="p">:</span>
                    <span class="n">particles_to_drop_insufficient_tilts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_ptcl</span><span class="p">)</span>

                <span class="c1"># append to an overall list for all particles</span>
                <span class="n">masked_visible_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masked_ptcl_visible_frames</span><span class="p">)</span>

            <span class="c1"># update the particles df header_ptcl_visible_frames to the newly masked visible_frames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_visible_frames</span>

            <span class="c1"># drop particles (rows) with fewer than use_first_ntilts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">particles_to_drop_insufficient_tilts</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># keep the first nptcls particles</span>
        <span class="k">if</span> <span class="n">use_first_nptcls</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping first </span><span class="si">{</span><span class="n">use_first_nptcls</span><span class="si">=}</span><span class="s1"> particles.&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">use_first_nptcls</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="c1"># recalculate the ptcls_unique_list due to possible upstream filtering invalidating the original list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">use_first_nptcls</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># reset indexing of TomoTomogramsStarfile tomogram block rows and of TomoParticlesStarfile header_ptcl_visible_frames to keep image indexing in .mrcs consistent with metadata indexing in .star</span>
        <span class="c1"># only necessary if images were sorted</span>
        <span class="k">if</span> <span class="n">sort_ptcl_imgs</span> <span class="o">!=</span> <span class="s1">&#39;unsorted&#39;</span><span class="p">:</span>

            <span class="n">unsorted_visible_frames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tomo_name</span><span class="p">,</span> <span class="n">ptcl_group_df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_tomogram</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

                <span class="c1"># create temporary index of sorted images</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;_reindexed_img_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]))</span>

                <span class="c1"># undo the tilt image sorting applied by sort_ptcl_imgs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

                <span class="c1"># undo the header_ptcl_visible_frames sorting applied by sort_ptcl_imgs</span>
                <span class="n">reordered_tilts_this_tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;_reindexed_img_order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="n">ptcl_group_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]:</span>
                    <span class="c1"># reindex this particle&#39;s visible frames</span>
                    <span class="n">unsorted_ptcl_visible_frames</span> <span class="o">=</span> <span class="n">ptcl_visible_frames</span><span class="p">[</span><span class="n">reordered_tilts_this_tomo</span><span class="p">]</span>
                    <span class="c1"># append to an overall list for all particles</span>
                    <span class="n">unsorted_visible_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unsorted_ptcl_visible_frames</span><span class="p">)</span>

                <span class="c1"># remove the temporary index of sorted images</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">tomo_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;_reindexed_img_order&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># update the particles df header_ptcl_visible_frames to the newly unsorted visible_frames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span> <span class="o">=</span> <span class="n">unsorted_visible_frames</span></div>


<div class="viewcode-block" id="TomoParticlesStarfile.make_test_train_split">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile.make_test_train_split">[docs]</a>
    <span class="k">def</span> <span class="nf">make_test_train_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">fraction_split1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                              <span class="n">show_summary_stats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create indices for tilt images assigned to train vs test split.</span>
<span class="sd">        Images are randomly assigned to one set or the other by precisely respecting `fraction_train` on a per-particle basis.</span>
<span class="sd">        Random split is stored in `self.df` under the `self.header_image_random_split` column as a list of ints in (0, 1, 2) with length `self.header_ptcl_visible_frames`.</span>
<span class="sd">        These values map as follows:</span>

<span class="sd">        * 0: images marked to not include (value 0) in `self.header_ptcl_visible_frames`.</span>
<span class="sd">        * 1: images marked to include (value 1) in `self.header_ptcl_visible_frames`, assigned to image-level half-set 1</span>
<span class="sd">        * 2: images marked to include (value 1) in `self.header_ptcl_visible_frames`, assigned to image-level half-set 2</span>

<span class="sd">        :param fraction_split1: fraction of each particle&#39;s included tilt images to label split1. All other included images will be labeled split2.</span>
<span class="sd">        :param show_summary_stats: log distribution statistics of particle sampling for test/train splits</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check required inputs are present</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">fraction_split1</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>

        <span class="c1"># get indices associated with train and test</span>
        <span class="n">train_test_split</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]:</span>
            <span class="c1"># get the number of included images, and split this set into the number of included assigned to train/test</span>
            <span class="n">ptcl_n_imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptcl_visible_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ptcl_n_imgs_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">ptcl_n_imgs</span> <span class="o">*</span> <span class="n">fraction_split1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ptcl_n_imgs_test</span> <span class="o">=</span> <span class="n">ptcl_n_imgs</span> <span class="o">-</span> <span class="n">ptcl_n_imgs_train</span>

            <span class="c1"># the initial array of ptcl_visible_frames already contains values in (0,1); set random ptcl_img_inds_test indices from 1 (include split1) to 2 (include split2)</span>
            <span class="n">ptcl_img_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ptcl_visible_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ptcl_img_inds_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">ptcl_img_inds</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ptcl_n_imgs_test</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ptcl_visible_frames</span><span class="p">[</span><span class="n">ptcl_img_inds_test</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="n">train_test_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ptcl_visible_frames</span><span class="p">)</span>

        <span class="c1"># store random split in particles dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_image_random_split</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_test_split</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomodrgn_added_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_image_random_split</span><span class="p">)</span>

        <span class="c1"># provide summary statistics</span>
        <span class="k">if</span> <span class="n">show_summary_stats</span><span class="p">:</span>
            <span class="n">ntilts_imgs_train</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptcl_imgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ptcl_imgs</span> <span class="ow">in</span> <span class="n">train_test_split</span><span class="p">]</span>
            <span class="n">ntilts_imgs_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptcl_imgs</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">ptcl_imgs</span> <span class="ow">in</span> <span class="n">train_test_split</span><span class="p">]</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Number of tilts sampled by inds_train: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ntilts_imgs_train</span><span class="p">)))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Number of tilts sampled by inds_test: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ntilts_imgs_test</span><span class="p">)))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TomoParticlesStarfile.plot_particle_uid_ntilt_distribution">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile.plot_particle_uid_ntilt_distribution">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_particle_uid_ntilt_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                             <span class="n">outpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the distribution of the number of visible tilt images per particle as a line plot (against star file particle index) and as a histogram.</span>

<span class="sd">        :param outpath: file name to save the plot</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ntilts_per_ptcl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>  <span class="c1"># number of included images per particle</span>
        <span class="n">unique_ntilts_per_ptcl</span><span class="p">,</span> <span class="n">ptcl_counts_per_unique_ntilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ntilts_per_ptcl</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ntilts_per_ptcl</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;star file particle index&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ntilts per particle&#39;</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">unique_ntilts_per_ptcl</span><span class="p">,</span> <span class="n">ptcl_counts_per_unique_ntilt</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ntilts per particle&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="TomoParticlesStarfile.get_particles_stack">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile.get_particles_stack">[docs]</a>
    <span class="k">def</span> <span class="nf">get_particles_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="o">*</span><span class="p">,</span>
                            <span class="n">datadir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">lazy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">check_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">mrc</span><span class="o">.</span><span class="n">LazyImageStack</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the particles referenced in the TomoParticlesStarfile.</span>
<span class="sd">        Particles are loaded into memory directly as a numpy array of shape ``(n_images, boxsize+1, boxsize+1)``, or as a list of ``mrc.LazyImageStack`` objects of length ``n_particles``.</span>
<span class="sd">        The column specifying the path to images on disk must not specify the image index to load from that file (i.e., syntax like ``1@/path/to/stack.mrcs`` is not supported).</span>
<span class="sd">        Instead, specification of which images to load for each particle should be done in the ``_rlnTomoVisibleFrames`` column.</span>

<span class="sd">        :param datadir: absolute path to particle images .mrcs to override particles_path_column.</span>
<span class="sd">        :param lazy: whether to load particle images now in memory (False) or later on-the-fly (True).</span>
<span class="sd">        :param check_headers: whether to parse each file&#39;s header to ensure consistency in dtype and array shape in X,Y (True),</span>
<span class="sd">                or to use the first .mrc(s) file as representative for the dataset (False).</span>
<span class="sd">                Caution that settting ``False`` is faster, but assumes that the first file&#39;s header is representative of all files.</span>
<span class="sd">        :return: np.ndarray of shape (n_ptcls * n_tilts, D, D) or list of LazyImage objects of length (n_ptcls * n_tilts)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assert that no paths include `@` specification of individual images to load from the referenced file</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">))</span>

        <span class="c1"># validate where to load MRC file(s) from disk</span>
        <span class="n">ptcl_mrcs_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_image</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">datadir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if star file contains relative paths to images, and star file is being loaded from other directory, try setting datadir to starfile abspath</span>
            <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourcefile</span><span class="p">)</span>
        <span class="n">ptcl_mrcs_files</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">prefix_paths</span><span class="p">(</span><span class="n">ptcl_mrcs_files</span><span class="p">,</span> <span class="n">datadir</span><span class="p">)</span>

        <span class="c1"># identify which tilt images to load for each particle</span>
        <span class="n">all_ptcls_visible_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>  <span class="c1"># [np.array([1, 1, 0]), np.array([1, 1, 1]), ...]</span>
        <span class="n">all_ptcls_visible_frames</span> <span class="o">=</span> <span class="p">[[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">include</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ptcl_visible_frames</span><span class="p">)</span> <span class="k">if</span> <span class="n">include</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="n">all_ptcls_visible_frames</span><span class="p">]</span>  <span class="c1"># [[0, 1], [0, 1, 2], ...]</span>

        <span class="c1"># create the LazyImageStack object for each particle</span>
        <span class="k">if</span> <span class="n">check_headers</span><span class="p">:</span>
            <span class="n">lazyparticles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mrc</span><span class="o">.</span><span class="n">LazyImageStack</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">ptcl_mrcs_file</span><span class="p">,</span> <span class="n">indices_image</span><span class="o">=</span><span class="n">ptcl_visible_frames</span><span class="p">,</span> <span class="n">representative_header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">ptcl_mrcs_file</span><span class="p">,</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ptcl_mrcs_files</span><span class="p">,</span> <span class="n">all_ptcls_visible_frames</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

            <span class="c1"># assert that all files have the same dtype and same image shape</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ptcl</span><span class="o">.</span><span class="n">dtype_image</span> <span class="o">==</span> <span class="n">lazyparticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype_image</span> <span class="k">for</span> <span class="n">ptcl</span> <span class="ow">in</span> <span class="n">lazyparticles</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ptcl</span><span class="o">.</span><span class="n">shape_image</span> <span class="o">==</span> <span class="n">lazyparticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape_image</span> <span class="k">for</span> <span class="n">ptcl</span> <span class="ow">in</span> <span class="n">lazyparticles</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">representative_header</span> <span class="o">=</span> <span class="n">mrc</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">ptcl_mrcs_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">lazyparticles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mrc</span><span class="o">.</span><span class="n">LazyImageStack</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">ptcl_mrcs_file</span><span class="p">,</span> <span class="n">indices_image</span><span class="o">=</span><span class="n">ptcl_visible_frames</span><span class="p">,</span> <span class="n">representative_header</span><span class="o">=</span><span class="n">representative_header</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">ptcl_mrcs_file</span><span class="p">,</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ptcl_mrcs_files</span><span class="p">,</span> <span class="n">all_ptcls_visible_frames</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">lazy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lazyparticles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># preallocating numpy array for in-place loading, fourier transform, fourier transform centering, etc.</span>
            <span class="c1"># allocating 1 extra pixel along x and y dimensions in anticipation of symmetrizing the hartley transform in-place</span>
            <span class="n">all_ptcls_nimgs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ptcl_visible_frames</span><span class="p">)</span> <span class="k">for</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="n">all_ptcls_visible_frames</span><span class="p">]</span>
            <span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">all_ptcls_nimgs</span><span class="p">),</span> <span class="n">lazyparticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lazyparticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape_image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">lazyparticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype_image</span><span class="p">)</span>
            <span class="n">loaded_images</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">lazyparticle</span><span class="p">,</span> <span class="n">ptcl_nimgs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lazyparticles</span><span class="p">,</span> <span class="n">all_ptcls_nimgs</span><span class="p">):</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">loaded_images</span><span class="p">:</span><span class="n">loaded_images</span> <span class="o">+</span> <span class="n">ptcl_nimgs</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lazyparticle</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">loaded_images</span> <span class="o">+=</span> <span class="n">ptcl_nimgs</span>
            <span class="k">return</span> <span class="n">particles</span></div>


<div class="viewcode-block" id="TomoParticlesStarfile.write">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.TomoParticlesStarfile.html#tomodrgn.starfile.TomoParticlesStarfile.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">outstar</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="o">*</span><span class="n">args</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Temporarily removes columns in data_particles dataframe that are present in data_optics dataframe (to restore expected input star file format), then calls parent GenericStarfile write.</span>
<span class="sd">        Writes both the TomoParticlesStar file and the updated Optimisation Set star file pointing to the new TomoParticlesStar file.</span>
<span class="sd">        The TomoParticlesStar file is written to the same directory as the optimisation set star file, and has the same name as the optimisation set after removing the string ``_optimisation_set``.</span>

<span class="sd">        :param outstar: name of the output optimisation set star file, optionally as absolute or relative path.</span>
<span class="sd">                Filename should include the string ``_optimisation_set``, e.g. ``run_optimisation_set.star``.</span>
<span class="sd">        :param args: Passed to parent GenericStarfile write</span>
<span class="sd">        :param kwargs: Passed to parent GenericStarfile write</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># during loading TomoParticlesStarfile, block_optics and block_particles are merged for internal convenience</span>
        <span class="n">columns_in_common</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1"># need to preserve the optics groups in the data_particles block</span>
        <span class="n">columns_in_common</span> <span class="o">=</span> <span class="n">columns_in_common</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">)</span>
        <span class="c1"># drop all other columns in common from the data_particles block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns_in_common</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># temporarily move columns added during __init__ to separate dataframe so that the written file does not contain these new columns</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tomodrgn_added_headers</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomodrgn_added_headers</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># temporarily convert self.header_ptcl_visible_frames to dtype str of list of int, as it was at input, for appropriate white-spacing in writing file to disk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">include</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ptcl_visible_frames</span><span class="p">])</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">for</span> <span class="n">ptcl_visible_frames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]]</span>

        <span class="c1"># now call parent write method for the TomoParticlesStar file</span>
        <span class="k">assert</span> <span class="s1">&#39;_optimisation_set&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outstar</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;The name of the output star file must include the string &quot;_optimisation_set&quot;, but got </span><span class="si">{</span><span class="n">outstar</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">outstar_particles</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outstar</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outstar</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_optimisation_set&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">outstar</span><span class="o">=</span><span class="n">outstar_particles</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># need to copy the tomoTomogramsFile to this new location -- can just copy (not starfile.write) because the file contents do not change</span>
        <span class="n">outstar_tomograms</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outstar</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomograms_star_path</span><span class="p">,</span> <span class="n">outstar_tomograms</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">SameFileError</span><span class="p">:</span>
            <span class="c1"># the file already exists at outstar_tomograms path</span>
            <span class="k">pass</span>

        <span class="c1"># also need to update the optimisation set contents and write out the updated optimisation set star file to the same directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;data_&#39;</span><span class="p">][</span><span class="s1">&#39;_rlnTomoParticlesFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outstar_particles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;data_&#39;</span><span class="p">][</span><span class="s1">&#39;_rlnTomoTomogramsFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outstar_tomograms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_set_star</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outstar</span><span class="o">=</span><span class="n">outstar</span><span class="p">)</span>

        <span class="c1"># re-merge data_optics with data_particles so that the starfile object appears unchanged after calling this method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_optics</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;_rlnOpticsGroup&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s1">&#39;many_to_one&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DROP&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^(?!.*_DROP)&#39;</span><span class="p">)</span>

        <span class="c1"># re-add the columns added during __init__ to restore the state of self.df from the start of this function call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># re-convert the header_ptcl_visible_frames to dtype np.array of int, as set during __init__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">include</span> <span class="k">for</span> <span class="n">include</span> <span class="ow">in</span> <span class="n">ptcl_frames</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                                                    <span class="k">for</span> <span class="n">ptcl_frames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_ptcl_visible_frames</span><span class="p">]]</span></div>
</div>



<div class="viewcode-block" id="is_starfile_optimisation_set">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.is_starfile_optimisation_set.html#tomodrgn.starfile.is_starfile_optimisation_set">[docs]</a>
<span class="k">def</span> <span class="nf">is_starfile_optimisation_set</span><span class="p">(</span><span class="n">star_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Infer whether a star file on disk is a RELION optimisation set, or some other type of star file.</span>
<span class="sd">    Defining characteristics of an optimisation set star file:</span>

<span class="sd">    * the data block name is ``data_``</span>
<span class="sd">    * the data block is a simple, two column, dictionary-style block</span>
<span class="sd">    * the data block minimally contains the keys ``_rlnTomoTomogramsFile`` and ``_rlnTomoParticlesFile``, as these are needed for tomodrgn</span>

<span class="sd">    :param star_path: path to potential optimisation set star file on disk</span>
<span class="sd">    :return: bool of whether the input star file matches characteristics of an optimisation set star file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># only skeletonize the star file for faster processing in case this is a large file (e.g. particle imageseries star file)</span>
    <span class="n">preambles</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">GenericStarfile</span><span class="o">.</span><span class="n">_skeletonize</span><span class="p">(</span><span class="n">star_path</span><span class="p">)</span>

    <span class="c1"># the data block named ``data_`` must be present</span>
    <span class="k">if</span> <span class="s1">&#39;data_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># the ``data_`` data block must be a dictionary-style block</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;data_&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># the ``data_`` data block must minimally contain keys ``_rlnTomoTomogramsFile`` and ``_rlnTomoParticlesFile``</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">{</span><span class="s1">&#39;_rlnTomoTomogramsFile&#39;</span><span class="p">,</span> <span class="s1">&#39;_rlnTomoParticlesFile&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;data_&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="load_sta_starfile">
<a class="viewcode-back" href="../../api/_autosummary/tomodrgn.starfile.load_sta_starfile.html#tomodrgn.starfile.load_sta_starfile">[docs]</a>
<span class="k">def</span> <span class="nf">load_sta_starfile</span><span class="p">(</span><span class="n">star_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">source_software</span><span class="p">:</span> <span class="n">KNOWN_STAR_SOURCES</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TiltSeriesStarfile</span> <span class="o">|</span> <span class="n">TomoParticlesStarfile</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads a tomodrgn star file handling class (either ``TiltSeriesStarfile`` or ``TomoParticlesStarfile``) from a star file on disk.</span>
<span class="sd">    The input ``star_path`` must point to either a particle imageseries star file (e.g. from Warp v1) or an optimisation set star file (e.g. from RELION v5).</span>
<span class="sd">    This is the preferred way of creating a tomodrgn starfile class instance.</span>

<span class="sd">    :param star_path: path to star file to load on disk</span>
<span class="sd">    :param source_software: type of source software used to create the star file, used to indicate the appropriate star file handling class to instantiate.</span>
<span class="sd">            Default of &#39;auto&#39; tries to infer the appropriate star file handling class based on whether ``star_path`` is an optimisation set star file.</span>
<span class="sd">    :return: The created starfile object (either ``TiltSeriesStarfile`` or ``TomoParticlesStarfile``)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">source_software</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_starfile_optimisation_set</span><span class="p">(</span><span class="n">star_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">TomoParticlesStarfile</span><span class="p">(</span><span class="n">star_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TiltSeriesStarfile</span><span class="p">(</span><span class="n">star_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_software</span> <span class="ow">in</span> <span class="n">get_args</span><span class="p">(</span><span class="n">TILTSERIESSTARFILE_STAR_SOURCES</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">TiltSeriesStarfile</span><span class="p">(</span><span class="n">star_path</span><span class="p">,</span> <span class="n">source_software</span><span class="o">=</span><span class="n">source_software</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source_software</span> <span class="ow">in</span> <span class="n">get_args</span><span class="p">(</span><span class="n">TOMOPARTICLESSTARFILE_STAR_SOURCES</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">TomoParticlesStarfile</span><span class="p">(</span><span class="n">star_path</span><span class="p">,</span> <span class="n">source_software</span><span class="o">=</span><span class="n">source_software</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized source_software </span><span class="si">{</span><span class="n">source_software</span><span class="si">}</span><span class="s1"> not one of known starfile sources </span><span class="si">{</span><span class="n">KNOWN_STAR_SOURCES</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, Barrett M Powell, Joseph H Davis.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>